<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Smart Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-icon-container {
            position: relative;
            cursor: pointer;
            margin-right: 20px;
        }

        .profile-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .profile-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .profile-icon-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            border: 2px solid white;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .welcome-text {
            text-align: right;
        }

        .welcome-text h2 {
            font-size: 1.2rem;
            color: #333;
            font-weight: 600;
        }

        .welcome-text p {
            color: #666;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, #f5576c, #f093fb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.3);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 10px 20px;
            margin: 20px auto 40px;
            max-width: 1400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow-x: auto;
            gap: 15px;
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #666;
            font-weight: 500;
            background: transparent;
            font-size: 0.9rem;
            flex: 1;
            text-align: center;
            justify-content: center;
            min-width: 120px;
        }

        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-icon {
            font-size: 1.2rem;
        }

        /* Main container */
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 40px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Content Sections */
        .content-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 300% 100%;
            animation: gradientMove 3s ease infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .section-header p {
            font-size: 1rem;
            color: #666;
            line-height: 1.5;
        }

        /* Welcome Card */
        .welcome-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .welcome-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .welcome-avatar {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-info h3 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 5px;
        }

        .welcome-info p {
            color: #666;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-content .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .stat-content .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Courses Grid */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .course-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .course-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .course-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .course-progress {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .course-progress-fill {
            background: linear-gradient(135deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }

        .course-progress-text {
            font-size: 0.9rem;
            color: #666;
            text-align: right;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Learning Grid Layout */
        .learning-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .course-section, .camera-section {
            min-height: 400px;
        }

        .section-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .course-placeholder {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Video Progress */
        .video-progress-section {
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-info {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .video-progress-bar {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .video-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        /* Enhanced Learning Progress Styles */
        .progress-main-display {
            margin-bottom: 25px;
        }
        
        .progress-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .stat-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            flex-shrink: 0;
        }
        
        .stat-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }
        
        .progress-bars-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .progress-bar-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .progress-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 6px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .progress-status {
            display: flex;
            justify-content: center;
            padding: 12px;
            background: rgba(74, 222, 128, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(74, 222, 128, 0.1);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #22c55e;
            font-weight: 500;
        }
        
        .status-icon {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .video-progress-fill {
            background: linear-gradient(135deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }

        .video-container {
            margin-bottom: 20px;
        }

        /* PDF Section */
        .pdf-section {
            margin-top: 20px;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pdf-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* Camera Section */
        .camera-container {
            text-align: center;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .metrics-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
        }

        .metric-value {
            font-weight: 600;
            color: #667eea;
        }

        /* Notes & Chat Grid */
        .notes-chat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .notes-section, .chatbot-section {
            min-height: 300px;
        }

        .notes-controls, .chatbot-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .notes-placeholder, .chat-placeholder {
            text-align: center;
            padding: 40px;
            color: #666;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
        }

        .chat-context {
            font-size: 0.8rem;
            color: #666;
        }

        /* Notes Selection Styles */
        .notes-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .notes-checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .note-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .note-checkbox-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .note-checkbox-item input[type="checkbox"] {
            margin: 0;
        }
        
        .note-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            flex: 1;
        }
        
        .note-checkbox-item .note-type {
            font-size: 0.8rem;
            color: #666;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        /* Chat typing indicator */
        .message.typing {
            opacity: 0.7;
        }
        
        .message.typing .message-content p::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        /* Form Group Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .form-group input[type="number"]:focus,
        .form-group input[type="text"]:focus,
        .form-group input[type="file"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .form-group input[type="file"] {
            cursor: pointer;
            padding: 10px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 222, 128, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        /* Form Card Enhancements */
        .form-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .form-card h3 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }
        
        /* Notes Chat Selection Styles */
        .notes-chat-selection {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .notes-chat-selection .notes-checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .notes-chat-selection .note-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .notes-chat-selection .note-checkbox-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.2);
        }
        
        .notes-chat-selection .note-checkbox-item.selected {
            background: rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }
        
        .notes-chat-selection .note-checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.1);
        }
        
        .notes-chat-selection .note-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Notes Display Styles */
        #myNotesDisplay {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #myNotesDisplay .content-section {
            background: transparent;
            padding: 0;
            box-shadow: none;
            border: none;
        }
        
        #myNotesDisplay .section-header {
            margin-bottom: 25px;
        }
        
        #myNotesDisplay .section-header h3 {
            color: #333;
            font-size: 1.4rem;
            margin-bottom: 8px;
        }
        
        #myNotesDisplay .section-header p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .note-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            border-color: rgba(102, 126, 234, 0.2);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .note-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .note-meta {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .note-type-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .note-date {
            color: #666;
            font-size: 0.8rem;
        }
        
        .note-content {
            color: #444;
            line-height: 1.6;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .note-summary {
            background: rgba(118, 75, 162, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #764ba2;
        }
        
        .note-summary h5 {
            color: #764ba2;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .note-summary p {
            color: #555;
            line-height: 1.5;
            margin: 0;
        }
        
        .note-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .note-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-view {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-view:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-download {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }
        
        .btn-download:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(74, 222, 128, 0.3);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #f5576c, #f093fb);
            color: white;
        }
        
        .btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3);
        }
        
        .no-notes {
            text-align: center;
            padding: 40px;
            color: #666;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            border: 2px dashed rgba(102, 126, 234, 0.2);
        }
        
        /* Chat File Upload Styles */
        .chat-input-container {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-input-container textarea {
            flex: 1;
            min-height: 80px;
            resize: vertical;
        }
        
        .chat-input-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 8px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .chat-notes-dropdown {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
        }
        
        .chat-notes-dropdown select {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-refresh-notes {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }
        
        .btn-refresh-notes:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-file-upload {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
        }
        
        .btn-file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
        }
        
        .notes-select {
            padding: 8px 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .notes-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        #chat-file-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            font-size: 0.9rem;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        #chat-file-info .file-name {
            font-weight: 600;
        }
        
        #chat-file-info .file-size {
            color: #666;
            font-size: 0.8rem;
        }
        
        #chat-file-info .remove-file {
            float: right;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Enhanced Chat Message Styles */
        .chat-message-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .user-message, .ai-message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border-radius: 16px;
            max-width: 100%;
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end;
        }
        
        .ai-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            align-self: flex-start;
        }
        
        .message-avatar {
            font-size: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }
        
        .message-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-header {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .message-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* AI Response Formatting */
        .response-section {
            margin-bottom: 16px;
        }
        
        .list-item {
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid rgba(255, 255, 255, 0.3);
        }
        
        .list-number {
            font-weight: bold;
            color: #ffd700;
            display: block;
            margin-bottom: 4px;
        }
        
        .list-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .bullet-point {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 3px solid rgba(255, 255, 255, 0.2);
        }
        
        strong {
            color: #ffd700;
            font-weight: 600;
        }
        
        /* Chat response area styling */
        #chat-response {
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        /* Smooth animations */
        .user-message, .ai-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Scrollbar styling */
        #chat-response::-webkit-scrollbar {
            width: 8px;
        }
        
        #chat-response::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }
        
        #chat-response::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }
        
        #chat-response::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
        
        /* Profile Overlay Styles */
        .profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .profile-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .profile-modal {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }
        
        .profile-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.5rem;
        }
        
        .profile-info p {
            margin: 0;
            opacity: 0.9;
        }
        
        .close-profile-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-profile-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .profile-content {
            padding: 30px;
        }
        
        .profile-section {
            margin-bottom: 30px;
        }
        
        .profile-section h4 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
        }
        
        .password-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        
        .password-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .password-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .profile-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Enhanced Password Form Styles */
        .section-icon {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        .password-form {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .password-input-group {
            margin-bottom: 20px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .label-icon {
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .form-input.password-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input.password-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .toggle-password {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggle-password:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }
        
        .eye-icon {
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .toggle-password:hover .eye-icon {
            transform: scale(1.2);
        }
        
        .password-strength, .password-match {
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            display: none;
        }
        
        .password-strength {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .password-strength.strong {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .password-strength.weak {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .password-match {
            background: rgba(40, 167, 69, 0.1);
            color: #155724;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .password-match.no-match {
            background: rgba(220, 53, 69, 0.1);
            color: #721c24;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .password-submit-btn {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .password-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .password-submit-btn:active {
            transform: translateY(0);
        }
        
        .btn-icon {
            font-size: 1.1rem;
        }
        
        /* Chat Notes Dropdown Styles */
        .chat-notes-dropdown {
            margin-right: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .notes-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .notes-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-refresh-notes {
            padding: 8px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px;
            height: 35px;
        }
        
        .btn-refresh-notes:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: rotate(180deg);
        }
        
        .btn-refresh-notes:active {
            transform: rotate(180deg) scale(0.95);
        }
        
        /* No Courses Available Styles */
        .no-courses-container {
            text-align: center;
            padding: 60px 40px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            border-radius: 20px;
            border: 2px dashed #cbd5e0;
            margin: 20px 0;
        }
        
        .no-courses-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .no-courses-title {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .no-courses-description {
            color: #718096;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .no-courses-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .no-courses-actions .btn {
            padding: 12px 24px;
            font-size: 0.95rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .no-courses-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        /* Tracking Status Styles */
        .tracking-status {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin-top: 10px;
        }
        
        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-indicator.inactive {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .status-indicator.active {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        /* PDF Viewer Styles */
        .pdf-viewer-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .pdf-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .pdf-viewer-header h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .pdf-viewer-header button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pdf-viewer-header button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .pdf-container {
            margin-top: 15px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .note-info {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .note-info .note-name {
            font-weight: 500;
        }
        
        .note-info .remove-note {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .note-info .remove-note:hover {
            background: rgba(220, 53, 69, 0.1);
            transform: scale(1.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .data-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .data-card p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .data-card .summary {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .data-card .summary h5 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        /* Chatbot Tab Styles */
        .response-area {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 100px;
        }
        
        .response-area h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .response-area p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .response-area .user-message {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .response-area .bot-message {
            background: rgba(118, 75, 162, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #764ba2;
        }
        
        .response-area .user-message strong {
            color: #667eea;
        }
        
        .response-area .bot-message strong {
            color: #764ba2;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);
        }
        
        .progress-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        .info-unit {
            color: #666;
            font-size: 0.8rem;
        }
        
        .auto-update-indicator {
            margin-top: 15px;
            text-align: center;
            padding: 8px 15px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .indicator-text {
            font-size: 0.8rem;
            color: #22c55e;
            font-weight: 600;
        }
        
        /* Progress Bar */
        .progress-display {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Progress Section */
        .progress-section {
            margin-top: 30px;
        }

        .progress-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .progress-display {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
        }

        /* Response Area */
        .response-area {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        /* Course Categories */
        .course-category {
            margin-bottom: 30px;
        }

        .category-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .category-title.in-progress {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .category-title.available {
            color: #f093fb;
            border-bottom-color: #f093fb;
        }

        .category-title.completed {
            color: #22c55e;
            border-bottom-color: #22c55e;
        }

        .courses-grid-small {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .course-card.completed {
            border: 2px solid #22c55e;
        }

        .course-card.in-progress {
            border: 2px solid #667eea;
        }

        .course-card.available {
            border: 2px solid #f093fb;
        }

        /* Material Tags */
        .material-tag {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        .course-info {
            margin-bottom: 20px;
        }

        .course-materials {
            margin-top: 10px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .learning-grid {
                grid-template-columns: 1fr;
            }
            
            .notes-chat-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .container {
                padding: 0 20px;
            }

            .tab-navigation {
                padding: 5px 10px;
                gap: 10px;
            }

            .tab-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
                min-width: 100px;
                flex: 1;
            }
            
            .progress-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .metrics-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon"></div>
                <h1>Smart Learning</h1>
            </div>
            <div class="user-info">
                <div class="profile-icon-container" onclick="toggleProfileOverlay()">
                    <div class="profile-icon"></div>
                </div>
                <div class="welcome-text">
                    <h2 id="userName">Welcome, Student!</h2>
                    <p>Dashboard</p>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Profile Overlay -->
    <div id="profileOverlay" class="profile-overlay" onclick="closeProfileOverlay(event)">
        <div class="profile-modal" onclick="event.stopPropagation()">
            <div class="profile-header">
                <div class="profile-avatar-large"></div>
                <div class="profile-info">
                    <h3 id="profileName">Student Name</h3>
                    <p id="profileEmail">student@example.com</p>
                    <p id="profileStudentId">Student ID: 4</p>
                </div>
                <button class="close-profile-btn" onclick="closeProfileOverlay()"></button>
            </div>
            
            <div class="profile-content">
                <div class="profile-section">
                    <h4>Account Details</h4>
                    <div class="detail-item">
                        <span class="detail-label">Full Name:</span>
                        <span id="profileFullName">John Doe</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email:</span>
                        <span id="profileEmailDetail">student@example.com</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Student ID:</span>
                        <span id="profileStudentIdDetail">4</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Role:</span>
                        <span>Student</span>
                    </div>
                </div>
                
                <div class="profile-section">
                    <h4><span class="section-icon"></span> Change Password</h4>
                    <form id="changePasswordForm" onsubmit="changePassword(event)" class="password-form">
                        <div class="password-input-group">
                            <div class="input-wrapper">
                                <label for="currentPassword" class="input-label">
                                    <span class="label-icon"></span>
                                    Current Password
                                </label>
                                <div class="password-input-container">
                                    <input type="password" id="currentPassword" class="form-input password-input" required>
                                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('currentPassword')">
                                        <span class="eye-icon"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="password-input-group">
                            <div class="input-wrapper">
                                <label for="newPassword" class="input-label">
                                    <span class="label-icon"></span>
                                    New Password
                                </label>
                                <div class="password-input-container">
                                    <input type="password" id="newPassword" class="form-input password-input" required minlength="6">
                                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('newPassword')">
                                        <span class="eye-icon"></span>
                                    </button>
                                </div>
                                <div class="password-strength" id="passwordStrength"></div>
                            </div>
                        </div>
                        
                        <div class="password-input-group">
                            <div class="input-wrapper">
                                <label for="confirmPassword" class="input-label">
                                    <span class="label-icon"></span>
                                    Confirm New Password
                                </label>
                                <div class="password-input-container">
                                    <input type="password" id="confirmPassword" class="form-input password-input" required minlength="6">
                                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirmPassword')">
                                        <span class="eye-icon"></span>
                                    </button>
                                </div>
                                <div class="password-match" id="passwordMatch"></div>
                            </div>
                        </div>
                        
                        <div class="password-message" id="passwordMessage"></div>
                        
                        <button type="submit" class="btn btn-primary password-submit-btn">
                            <span class="btn-icon"></span>
                            Change Password
                        </button>
                    </form>
                </div>
                
                <div class="profile-actions">
                    <button class="btn btn-secondary" onclick="closeProfileOverlay()">Close</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation" id="tabNavigation">
        <button class="tab-btn active" onclick="showTab('dashboard')">
            <span class="tab-icon"></span>
            <span>Dashboard</span>
        </button>
        <button class="tab-btn" onclick="showTab('learning')">
            <span class="tab-icon"></span>
            <span>Learning Hub</span>
        </button>
        <button class="tab-btn" onclick="showTab('notes')">
            <span class="tab-icon"></span>
            <span>Notes</span>
        </button>
        <button class="tab-btn" onclick="showTab('chatbot')">
            <span class="tab-icon"></span>
            <span>AI Assistant</span>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="content-section">
                <div class="section-header">
                    <h2> My Learning Dashboard</h2>
                    <p>Track your progress and view your learning journey</p>
                </div>

                <!-- Student Welcome Card -->
                <div class="welcome-card">
                    <div class="welcome-content">
                        <div class="welcome-avatar"></div>
                        <div class="welcome-info">
                            <h3 id="studentWelcomeName">Welcome back!</h3>
                            <p id="studentRole">Student</p>
                        </div>
                    </div>
                </div>

                <!-- Progress Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="progressPercentage">0%</div>
                            <div class="stat-label">Overall Progress</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="cognitiveLevel">0%</div>
                            <div class="stat-label">Cognitive Load</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="engagementRate">0%</div>
                            <div class="stat-label">Engagement</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalTimeSpent">0h</div>
                            <div class="stat-label">Time Spent</div>
                        </div>
                    </div>
                </div>

                <!-- Current Courses -->
                <div class="courses-section">
                    <h3> My Courses</h3>
                    <div class="courses-grid" id="studentCoursesGrid">
                        <!-- Courses will be loaded here -->
                    </div>
                </div>

                <div class="loading" id="dashboard-loading">
                    <div class="spinner"></div>
                    <p>Loading your dashboard...</p>
                </div>
            </div>
        </div>

        <!-- Learning Hub Tab -->
        <div id="learning" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2> My Learning Hub</h2>
                    <p>Attend courses, take notes, and get AI assistance - all in one place</p>
                </div>

                <!-- Course Player Section -->
                <div class="learning-grid">
                    <div class="course-section">
                        <div class="section-card">
                            <h3> Current Course</h3>
                            <div id="currentCourseInfo">
                                <div class="course-placeholder">
                                    <p>Select a course to begin learning</p>
                                </div>
                            </div>
                            <div class="course-controls">
                                <div class="form-group">
                                    <label for="courseSelect">Choose Course:</label>
                                    <select id="courseSelect" onchange="loadSelectedCourse()">
                                        <option value="">Select a course...</option>
                                    </select>
                                </div>
                                <div id="coursePlayer" style="display:none;">
                                    <!-- Video Progress Section -->
                                    <div class="video-progress-section">
                                        <div class="progress-header">
                                            <h4> Course Video</h4>
                                            <div class="progress-info">
                                                <span id="videoProgress">0%</span> completed
                                                <span id="videoTime">0:00 / 0:00</span>
                                            </div>
                                        </div>
                                        <div class="video-progress-bar">
                                            <div class="video-progress-fill" id="videoProgressFill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Video Player -->
                                    <div class="video-container">
                                        <video id="courseVideo" controls style="width: 100%; max-height: 400px;" 
                                               onplay="onVideoPlay()" 
                                               onpause="onVideoPause()" 
                                               ontimeupdate="onVideoTimeUpdate()"
                                               onloadedmetadata="onVideoLoaded()"
                                               onloadeddata="onVideoDataLoaded()"
                                               ondurationchange="onVideoDurationChange()"
                                               onprogress="onVideoProgress()"
                                               onended="onVideoCompleted()">
                                        </video>
                                    </div>
                                    
                                    <!-- PDF Section -->
                                    <div class="pdf-section">
                                        <div class="pdf-header">
                                            <h4> Course Materials</h4>
                                            <div class="pdf-actions">
                                                <button class="btn btn-sm btn-primary" onclick="viewPDF()" id="viewPDFBtn">
                                                     View PDF
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="downloadPDF()" id="downloadPDFBtn">
                                                     Download PDF
                                                </button>
                                            </div>
                                        </div>
                                        <div class="pdf-container" id="pdfContainer" style="display:none;">
                                            <div class="pdf-viewer-wrapper">
                                                <div class="pdf-viewer-header">
                                                    <h5> Course PDF</h5>
                                                    <button class="btn btn-sm btn-secondary" onclick="closePDFViewer()">
                                                         Close
                                                    </button>
                                                </div>
                                                <iframe id="pdfViewer" style="width: 100%; height: 500px; border: none; border-radius: 8px;" frameborder="0"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Camera Section -->
                    <div class="camera-section">
                        <div class="section-card">
                            <h3> Learning Analytics</h3>
                            <div class="camera-container">
                                <video id="cameraVideo" autoplay playsinline style="width: 100%; max-height: 200px; border-radius: 10px;"></video>
                                <div class="camera-controls">
                                    <!-- Camera tracking is now automatic with video play/pause -->
                                    <div class="tracking-status">
                                        <span class="status-indicator inactive" id="trackingStatus"> Tracking Inactive</span>
                                    </div>
                                </div>
                                <div class="metrics-display">
                                    <div class="metric-item">
                                        <span class="metric-label"> Gaze:</span>
                                        <span class="metric-value" id="gazeMetric">--%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label"> Attention:</span>
                                        <span class="metric-value" id="attentionMetric">--%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label"> Cognitive Load:</span>
                                        <span class="metric-value" id="cognitiveMetric">--%</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label"> Engagement:</span>
                                        <span class="metric-value" id="engagementMetric">--%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Display (Real-time) -->
                <div class="progress-section">
                    <div class="section-card">
                        <h3> Learning Progress</h3>
                        
                        <!-- Main Progress Display -->
                        <div class="progress-main-display">
                            <div class="progress-stats-grid">
                                <div class="stat-item">
                                    <div class="stat-icon"></div>
                                    <div class="stat-info">
                                        <span class="stat-value" id="timeSpent">0</span>
                                        <span class="stat-label">minutes</span>
                                    </div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-icon"></div>
                                    <div class="stat-info">
                                        <span class="stat-value" id="progressText">0%</span>
                                        <span class="stat-label">complete</span>
                                    </div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-icon"></div>
                                    <div class="stat-info">
                                        <span class="stat-value" id="videoProgressDisplay">0%</span>
                                        <span class="stat-label" id="videoTimeDisplay">0:00 / 0:00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bars -->
                        <div class="progress-bars-container">
                            <div class="progress-bar-item">
                                <div class="progress-label"> Course Progress</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="progress-bar-item">
                                <div class="progress-label"> Video Progress</div>
                                <div class="video-progress-bar">
                                    <div class="video-progress-fill" id="videoProgressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Indicator -->
                        <div class="progress-status">
                            <div class="status-indicator">
                                <span class="status-icon"></span>
                                <span class="status-text">Auto-updating based on video progress</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="loading" id="learning-loading">
                    <div class="spinner"></div>
                    <p>Processing...</p>
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        <div id="notes" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2> Notes Management</h2>
                    <p>Upload and organize your study notes</p>
                </div>

                <div class="form-grid">
                    <div class="form-card">
                        <h3><span></span> Upload Note</h3>
                        <div class="form-group">
                            <label for="note-file">Select File (TXT/PDF):</label>
                            <input type="file" id="note-file" accept=".txt,.pdf">
                        </div>
                        <button class="btn btn-success" onclick="uploadNotes()">Upload Note</button>
                    </div>
                </div>

                <!-- Notes Display Section -->
                <div id="myNotesDisplay" style="display: none; margin-top: 30px;">
                    <div class="content-section">
                        <div class="section-header">
                            <h3> My Uploaded Notes</h3>
                            <p>View and manage your study notes</p>
                        </div>
                        <div id="notesListDisplay">
                            <!-- Notes will be displayed here -->
                        </div>
                    </div>
                </div>

                <div class="loading" id="notes-loading">
                    <div class="spinner"></div>
                    <p>Processing notes...</p>
                </div>
            </div>
        </div>

        <!-- AI Assistant Tab -->
        <div id="chatbot" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2> AI Notes Assistant</h2>
                    <p>Get summaries and answers based on your uploaded notes</p>
                </div>

                <div class="form-card">
                    <h3><span></span> Ask AI Assistant</h3>
                    <div class="form-group">
                        <label for="chat-message">Ask a question about your notes:</label>
                        
                        <!-- Integrated Chat Input Area -->
                        <div class="chat-input-container">
                            <textarea id="chat-message" placeholder="What would you like to know about your notes?" rows="3" onkeypress="handleChatKeyPress(event)"></textarea>
                            
                            <!-- Chat Actions Inside Input Area -->
                            <div class="chat-input-actions">
                                <!-- Note Selection Dropdown -->
                                <div class="chat-notes-dropdown">
                                    <select id="chat-notes-select" class="notes-select" onchange="handleChatNoteSelection()">
                                        <option value=""> Select a note to include...</option>
                                    </select>
                                    <button type="button" class="btn-refresh-notes" onclick="loadChatNotesDropdown()" title="Refresh notes list">
                                        
                                    </button>
                                </div>
                                
                                <!-- File Upload Button -->
                                <input type="file" id="chat-file-upload" accept=".txt,.pdf" style="display: none;" onchange="handleChatFileSelect(this)">
                                <button type="button" class="btn-file-upload" onclick="document.getElementById('chat-file-upload').click()" title="Upload file">
                                    
                                </button>
                            </div>
                        </div>
                        
                        <!-- File and Note Info Display -->
                        <div id="chat-file-info" class="file-info" style="display: none;"></div>
                        <div id="chat-note-info" class="note-info" style="display: none;"></div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendChatMessageWithNote()"> Get AI Help</button>
                </div>

                <div class="response-area" id="chat-response">
                    AI responses based on your notes will appear here...
                </div>
                
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearChatHistory()" style="padding: 8px 16px; font-size: 0.9rem;">
                         Clear Chat
                    </button>
                </div>

                <div class="loading" id="chat-loading">
                    <div class="spinner"></div>
                    <p>AI is analyzing your notes...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let userId = null;
        let studentId = null;
        let userName = null;

        // Initialize
        window.onload = function() {
            // Get user and student IDs from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id') || localStorage.getItem('user_id');
            const studentId = urlParams.get('student_id') || localStorage.getItem('student_id');
            
            if (!userId || !studentId) {
                // Redirect to login if credentials are missing
                window.location.href = 'auth.html';
                return;
            }
            
            // Store user info in localStorage
            localStorage.setItem('user_id', userId);
            localStorage.setItem('student_id', studentId);
            
            // Update UI with user name
            const userName = urlParams.get('name') || localStorage.getItem('user_name') || 'Student';
            document.getElementById('userName').textContent = `Welcome, ${userName}!`;
            document.getElementById('studentWelcomeName').textContent = `Welcome back, ${userName}!`;
            
            // Store user name in localStorage for future use
            localStorage.setItem('user_name', userName);
            
            // Load dashboard data
            loadDashboardData();
            
            // Load student notes
            loadStudentNotes();
        };

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            if (event && event.target) {
                event.target.closest('.tab-btn').classList.add('active');
            }
            
            // Load tab-specific data
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'learning') {
                // Load courses for dropdown
                loadCoursesForDropdown();
                
                // Check if there's a selected course to load
                const selectedCourseId = localStorage.getItem('selected_course_id');
                if (selectedCourseId) {
                    loadCourseDetails(parseInt(selectedCourseId));
                    // Clear the stored course ID after loading
                    localStorage.removeItem('selected_course_id');
                }
            } else if (tabName === 'chatbot') {
                // Load notes dropdown when chatbot tab is opened
                loadChatNotesDropdown();
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            document.getElementById('dashboard-loading').style.display = 'block';

            try {
                // Get current user from localStorage
                const currentUser = {
                    user_id: parseInt(localStorage.getItem('user_id')),
                    student_id: parseInt(localStorage.getItem('student_id')),
                    user_name: localStorage.getItem('user_name')
                };
                
                if (!currentUser.student_id) {
                    console.error('No student ID found');
                    return;
                }

                const response = await fetch(`${API_BASE}/students/${currentUser.student_id}/dashboard`);
                const data = await response.json();

                if (response.ok) {
                    // Update stats with real data
                    document.getElementById('progressPercentage').textContent = `${(data.progress_percentage * 100).toFixed(1)}%`;
                    document.getElementById('cognitiveLevel').textContent = `${data.cognitive_load_level}%`;
                    document.getElementById('engagementRate').textContent = '85%'; // Default engagement
                    document.getElementById('totalTimeSpent').textContent = '12h'; // Calculate from backend

                    // Load student's assigned courses
                    await loadStudentCourses();
                } else {
                    console.error('Failed to load dashboard data');
                    // Use sample data as fallback
                    document.getElementById('progressPercentage').textContent = '75%';
                    document.getElementById('cognitiveLevel').textContent = '45%';
                    document.getElementById('engagementRate').textContent = '82%';
                    document.getElementById('totalTimeSpent').textContent = '12h';
                    await loadStudentCourses();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Use sample data as fallback
                document.getElementById('progressPercentage').textContent = '75%';
                document.getElementById('cognitiveLevel').textContent = '45%';
                document.getElementById('engagementRate').textContent = '82%';
                document.getElementById('totalTimeSpent').textContent = '12h';
                await loadStudentCourses();
            } finally {
                document.getElementById('dashboard-loading').style.display = 'none';
            }
        }

        // Load student courses
        async function loadStudentCourses() {
            const studentId = parseInt(localStorage.getItem('student_id'));
            if (!studentId) {
                console.error('No student ID found');
                return;
            }
            
            try {
                console.log('Loading courses with progress from API...');
                // Add cache-busting parameter to ensure fresh data
                const timestamp = Date.now();
                const response = await fetch(`${API_BASE}/students/${studentId}/courses_with_progress?_t=${timestamp}`);
                const coursesWithProgress = await response.json();
                
                console.log('API Response:', response.ok, coursesWithProgress);

                if (response.ok && coursesWithProgress && coursesWithProgress.length > 0) {
                    // Display courses with progress
                    displayStudentCourses(coursesWithProgress);
                } else {
                    console.log('No courses from API');
                    // Fallback to sample courses
                    addSampleCourses();
                }
            } catch (error) {
                console.error('Error loading courses with progress:', error);
                // Fallback to sample courses
                addSampleCourses();
            }
        }

        // Display student courses
        function displayStudentCourses(courses) {
            console.log('Displaying courses:', courses);
            const coursesGrid = document.getElementById('studentCoursesGrid');
            
            if (!coursesGrid) {
                console.error('studentCoursesGrid element not found!');
                return;
            }
            
            if (!courses || courses.length === 0) {
                console.log('No courses to display');
                // Let the "no courses" message be handled by the HTML building logic
                return;
            }

            console.log('Processing', courses.length, 'courses');

            // Categorize courses based on progress
            const completedCourses = [];
            const inProgressCourses = [];
            const availableCourses = [];

            courses.forEach(course => {
                // For new courses, check if they have any progress data
                // If no progress data, treat as available (0% progress)
                const progress = course.progress || 0;
                course.progress = progress;
                course.progressPercentage = progress.toFixed(1);
                
                // More robust progress comparison
                if (progress >= 99.9) { // Consider 99.9%+ as completed (handles floating point precision)
                    completedCourses.push(course);
                } else if (progress > 1.0) { // Consider >1% as in progress
                    inProgressCourses.push(course);
                } else {
                    availableCourses.push(course);
                }
            });

            console.log('Course categories:', {
                completed: completedCourses.length,
                inProgress: inProgressCourses.length,
                available: availableCourses.length,
                completedCourses: completedCourses.map(c => ({ id: c.id, title: c.title, progress: c.progress })),
                inProgressCourses: inProgressCourses.map(c => ({ id: c.id, title: c.title, progress: c.progress })),
                availableCourses: availableCourses.map(c => ({ id: c.id, title: c.title, progress: c.progress }))
            });

            // Build HTML with categorized sections
            let html = '';

            // Completed Courses Section (show first)
            if (completedCourses.length > 0) {
                html += `
                    <div class="course-category">
                        <h3 class="category-title completed"> Completed Courses</h3>
                        <div class="courses-grid-small">
                            ${completedCourses.map(course => createCourseCard(course, 'completed')).join('')}
                        </div>
                    </div>
                `;
            }

            // In Progress Courses Section
            if (inProgressCourses.length > 0) {
                html += `
                    <div class="course-category">
                        <h3 class="category-title in-progress"> In Progress</h3>
                        <div class="courses-grid-small">
                            ${inProgressCourses.map(course => createCourseCard(course, 'in-progress')).join('')}
                        </div>
                    </div>
                `;
            }

            // Available Courses Section
            if (availableCourses.length > 0) {
                html += `
                    <div class="course-category">
                        <h3 class="category-title available"> Available Courses</h3>
                        <div class="courses-grid-small">
                            ${availableCourses.map(course => createCourseCard(course, 'available')).join('')}
                        </div>
                    </div>
                `;
            }

            // If no courses at all, show message
            if (inProgressCourses.length === 0 && availableCourses.length === 0 && completedCourses.length === 0) {
                html = `
                    <div class="no-courses-container">
                        <div class="no-courses-icon"></div>
                        <h3 class="no-courses-title">No Current Courses Available</h3>
                        <p class="no-courses-description">
                            You don't have any assigned courses yet. Contact your teacher to get started with your learning journey.
                        </p>
                        <div class="no-courses-actions">
                            <button class="btn btn-secondary" onclick="showTab('learning')">
                                 Browse Learning Hub
                            </button>
                        </div>
                    </div>
                `;
            }

            coursesGrid.innerHTML = html;
        }

        // Load all courses
        async function loadCourses() {
            document.getElementById('courses-loading').style.display = 'block';
            
            try {
                // Simulate API call
                setTimeout(() => {
                    document.getElementById('courses-loading').style.display = 'none';
                    console.log('Courses loaded successfully!');
                }, 1000);
            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('courses-loading').style.display = 'none';
            }
        }

        // Start learning session
        function startLearning() {
            const courseSelect = document.getElementById('courseSelect');
            if (courseSelect.value) {
                alert(`Starting learning session for course: ${courseSelect.value}`);
            } else {
                alert('Please select a course first');
            }
        }

        // Create course card HTML
        function createCourseCard(course, status) {
            const statusClass = status === 'completed' ? 'completed' : status === 'in-progress' ? 'in-progress' : 'available';
            const buttonText = status === 'completed' ? ' Review Course' : status === 'in-progress' ? ' Continue Learning' : ' Start Course';
            const buttonClass = status === 'completed' ? 'btn-secondary' : 'btn-primary';
            const buttonAction = status === 'completed' ? `reviewCompletedCourse(${course.id})` : `startCourse(${course.id})`;
            
            return `
                <div class="course-card ${statusClass}">
                    <h3 class="course-title">${course.title}</h3>
                    <p class="course-description">${course.description}</p>
                    <div class="course-progress">
                        <div class="course-progress-fill" style="width: ${course.progress}%"></div>
                    </div>
                    <div class="course-progress-text">${course.progressPercentage}% Complete</div>
                    <button class="btn ${buttonClass}" style="margin-top: 15px; margin-left: 10px;" onclick="${buttonAction}">${buttonText}</button>
                </div>
            `;
        }

        // Review completed course with detailed performance popup
        function reviewCompletedCourse(courseId) {
            console.log('Reviewing completed course:', courseId);
            
            // Fetch course details and student performance
            const studentId = parseInt(localStorage.getItem('student_id'));
            if (!studentId) {
                alert('Please login to review course details');
                return;
            }
            
            // Show loading popup
            showLoadingPopup('Loading course details...');
            
            // Fetch course details, performance, and analytics in parallel
            Promise.all([
                fetch(`${API_BASE}/courses/${courseId}`),
                fetch(`${API_BASE}/students/${studentId}/courses/${courseId}/progress`),
                fetch(`${API_BASE}/students/${studentId}/metrics_history?course_id=${courseId}&limit=50`)
            ])
            .then(async ([courseResponse, progressResponse, metricsResponse]) => {
                const course = await courseResponse.json();
                const progress = progressResponse.ok ? await progressResponse.json() : null;
                const metrics = metricsResponse.ok ? await metricsResponse.json() : [];
                
                console.log('Course review data received:', {
                    course: course.title,
                    progress: progress,
                    metricsCount: metrics.length,
                    sampleMetrics: metrics.slice(0, 2)
                });
                
                if (!courseResponse.ok) {
                    throw new Error('Failed to load course details');
                }
                
                hideLoadingPopup();
                showCourseReviewPopup(course, progress, metrics);
            })
            .catch(error => {
                console.error('Error loading course review data:', error);
                hideLoadingPopup();
                alert('Error loading course details. Please try again.');
            });
        }
        
        // Show loading popup
        function showLoadingPopup(message) {
            const popup = document.createElement('div');
            popup.id = 'loadingPopup';
            popup.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 1000; backdrop-filter: blur(5px);
            `;
            
            popup.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                    <h3 style="margin: 0 0 10px 0; color: #333;">${message}</h3>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">Please wait...</p>
                </div>
            `;
            
            document.body.appendChild(popup);
        }
        
        // Hide loading popup
        function hideLoadingPopup() {
            const popup = document.getElementById('loadingPopup');
            if (popup) {
                popup.remove();
            }
        }
        
        // Show comprehensive course review popup
        function showCourseReviewPopup(course, progress, metrics) {
            const popup = document.createElement('div');
            popup.id = 'courseReviewPopup';
            popup.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 1000; backdrop-filter: blur(5px);
            `;
            
            // Calculate performance metrics
            const avgCognitiveLoad = metrics.length > 0 ? 
                (metrics.reduce((sum, m) => sum + (m.cognitive_load || 0), 0) / metrics.length).toFixed(1) : 'N/A';
            const avgEngagement = metrics.length > 0 ? 
                (metrics.reduce((sum, m) => sum + (m.engagement_level || 0), 0) / metrics.length).toFixed(1) : 'N/A';
            const totalTimeSpent = progress ? progress.time_spent_minutes : 0;
            const completionDate = progress && progress.course_completed ? 
                new Date().toLocaleDateString() : 'N/A';
            
            console.log('Calculated metrics:', {
                avgCognitiveLoad,
                avgEngagement, 
                totalTimeSpent,
                metricsCount: metrics.length,
                sampleMetrics: metrics.slice(0, 2)
            });
            
            // Determine performance level
            let performanceLevel = ' Excellent';
            let performanceColor = '#10b981';
            if (avgCognitiveLoad > 80 || avgEngagement < 60) {
                performanceLevel = ' Good';
                performanceColor = '#f59e0b';
            }
            if (avgCognitiveLoad > 90 || avgEngagement < 40) {
                performanceLevel = ' Needs Improvement';
                performanceColor = '#ef4444';
            }
            
            popup.innerHTML = `
                <div style="background: white; padding: 0; border-radius: 20px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px 20px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;"> Course Review</h2>
                                <h3 style="margin: 0; font-size: 1.3rem; opacity: 0.9;">${course.title}</h3>
                            </div>
                            <button onclick="this.closest('#courseReviewPopup').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-size: 1.2rem;"></button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 30px;">
                        <!-- Course Overview -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;"> Course Overview</h4>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 15px; border-left: 4px solid #667eea;">
                                <p style="margin: 0 0 10px 0; color: #666;"><strong>Description:</strong> ${course.description || 'No description available'}</p>
                                <p style="margin: 0 0 10px 0; color: #666;"><strong>Duration:</strong> ${course.duration_minutes || 'N/A'} minutes</p>
                                <p style="margin: 0 0 10px 0; color: #666;"><strong>Difficulty:</strong> ${course.difficulty_level || 'N/A'}</p>
                                <p style="margin: 0; color: #666;"><strong>Completed:</strong> ${completionDate}</p>
                            </div>
                        </div>
                        
                        <!-- Performance Summary -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;"> Your Performance Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #10b981;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">100%</div>
                                    <div style="color: #666; font-size: 0.9rem;">Course Completed</div>
                                </div>
                                
                                <div style="background: #fef3c7; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #f59e0b;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${Math.round(totalTimeSpent)} min</div>
                                    <div style="color: #666; font-size: 0.9rem;">Time Spent</div>
                                </div>
                                
                                <div style="background: #dbeafe; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #3b82f6;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${avgCognitiveLoad}%</div>
                                    <div style="color: #666; font-size: 0.9rem;">Avg Cognitive Load</div>
                                </div>
                                
                                <div style="background: #fce7f3; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #ec4899;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #ec4899;">${avgEngagement}%</div>
                                    <div style="color: #666; font-size: 0.9rem;">Avg Engagement</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Assessment -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;"> Performance Assessment</h4>
                            <div style="background: ${performanceColor}20; padding: 20px; border-radius: 15px; border-left: 4px solid ${performanceColor};">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <span style="font-size: 1.5rem; margin-right: 10px;">${performanceLevel.split(' ')[0]}</span>
                                    <span style="font-size: 1.2rem; font-weight: bold; color: ${performanceColor};">${performanceLevel.split(' ')[1]}</span>
                                </div>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                    ${getPerformanceMessage(avgCognitiveLoad, avgEngagement, totalTimeSpent)}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Learning Analytics Chart -->
                        ${metrics.length > 0 ? `
                        <div style="margin-bottom: 30px;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.2rem;"> Learning Analytics</h4>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 15px;">
                                <canvas id="performanceChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="continueCourse(${course.id})" style="background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                                 Review Materials
                            </button>
                            <button onclick="downloadCourseCertificate(${course.id})" style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                                 Download Certificate
                            </button>
                            <button onclick="this.closest('#courseReviewPopup').remove()" style="background: #64748b; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Draw performance chart if metrics available
            if (metrics.length > 0) {
                setTimeout(() => drawPerformanceChart(metrics), 100);
            }
        }
        
        // Get performance assessment message
        function getPerformanceMessage(cognitiveLoad, engagement, timeSpent) {
            if (cognitiveLoad < 60 && engagement > 80 && timeSpent > 30) {
                return 'Excellent performance! You maintained optimal cognitive load while staying highly engaged throughout the course.';
            } else if (cognitiveLoad < 80 && engagement > 60) {
                return 'Good performance! You balanced cognitive load and engagement well. Consider reviewing challenging sections.';
            } else if (cognitiveLoad > 85) {
                return 'High cognitive load detected. The course was challenging for you. Consider reviewing foundational concepts.';
            } else if (engagement < 50) {
                return 'Lower engagement levels noted. Try to find more interactive ways to engage with the material.';
            } else {
                return 'Course completed successfully. Continue to focus on maintaining engagement and managing cognitive load.';
            }
        }
        
        // Draw performance chart
        function drawPerformanceChart(metrics) {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Simple line chart showing cognitive load over time
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const padding = 40;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            metrics.forEach((metric, index) => {
                const x = padding + (index / (metrics.length - 1)) * chartWidth;
                const y = padding + chartHeight - (metric.cognitive_load / 100) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Draw point
                ctx.fillStyle = '#667eea';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.stroke();
            
            // Draw axes
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#666';
            ctx.font = '12px sans-serif';
            ctx.fillText('Cognitive Load Trend', padding, padding - 10);
            ctx.fillText('Time ', width - padding - 30, height - padding + 20);
        }
        
        // Download course certificate (placeholder)
        function downloadCourseCertificate(courseId) {
            alert(' Certificate download feature coming soon! This will generate a PDF certificate of completion.');
        }
        function continueCourse(courseId) {
            console.log('Continue course called with ID:', courseId);
            
            // Store selected course and redirect to learning hub
            localStorage.setItem('selected_course_id', courseId);
            console.log('Stored course ID in localStorage');
            
            showTab('learning');
            console.log('Switched to learning tab');
            
            // Load course details in learning hub
            loadCurrentCourse();
        }
        
        // Start course (new function)
        function startCourse(courseId) {
            console.log('Start course called with ID:', courseId);
            
            // Reset progress for new course start
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            // Call backend to reset progress
            fetch(`${API_BASE}/students/${studentId}/start_course/${courseId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Course started:', data);
                
                // Store selected course and redirect to learning hub
                localStorage.setItem('selected_course_id', courseId);
                showTab('learning');
                
                // Load course details in learning hub
                loadCurrentCourse();
            })
            .catch(error => {
                console.error('Error starting course:', error);
                alert('Error starting course. Please try again.');
            });
        }

        // Load current course in learning hub
        function loadCurrentCourse() {
            const courseId = localStorage.getItem('selected_course_id');
            if (courseId) {
                console.log('Loading current course:', courseId);
                loadCourseDetails(parseInt(courseId));
            } else {
                console.log('No course selected');
            }
        }

        // Load course details for learning hub
        async function loadCourseDetails(courseId) {
            console.log('Loading course details for ID:', courseId);
            
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                
                // Fetch both course details and course progress in parallel
                const [courseResponse, progressResponse] = await Promise.all([
                    fetch(`${API_BASE}/courses/${courseId}`),
                    studentId ? fetch(`${API_BASE}/students/${studentId}/courses/${courseId}/progress`) : Promise.resolve({ ok: false })
                ]);
                
                console.log('Course details API response status:', courseResponse.status);
                console.log('Course progress API response status:', progressResponse.status);
                
                const course = await courseResponse.json();
                console.log('Course details received:', course);
                
                let courseProgress = { progress_percentage: 0, time_spent_minutes: 0 };
                if (progressResponse.ok) {
                    courseProgress = await progressResponse.json();
                    console.log('Course progress received:', courseProgress);
                }
                
                if (courseResponse.ok) {
                    // Update course select
                    const courseSelect = document.getElementById('courseSelect');
                    if (courseSelect) {
                        courseSelect.value = courseId;
                        console.log('Updated course select to:', courseId);
                    }
                    
                    // Load course content with progress data
                    loadCourseContent(course, courseProgress);
                    console.log('Called loadCourseContent with progress');
                } else {
                    console.error('Failed to load course details from API, checking sample courses');
                    // Try to load from sample courses
                    loadSampleCourseContent(courseId);
                }
            } catch (error) {
                console.error('Error loading course details:', error);
                console.log('Trying to load sample course content');
                // Try to load from sample courses
                loadSampleCourseContent(courseId);
            }
        }
        
        // Load sample course content when API fails
        function loadSampleCourseContent(courseId) {
            const sampleCourses = window.sampleCoursesData || [];
            const course = sampleCourses.find(c => c.id === courseId);
            
            if (course) {
                console.log('Loading sample course:', course.title);
                loadCourseContent(course);
            } else {
                console.error('Sample course not found:', courseId);
                // Show error message
                const courseInfo = document.getElementById('currentCourseInfo');
                courseInfo.innerHTML = `
                    <div class="error-message">
                        <p> Course not found or unable to load course details.</p>
                        <p>Please try selecting a different course.</p>
                    </div>
                `;
                // Hide course player
                document.getElementById('coursePlayer').style.display = 'none';
            }
        }
        
        // Load course content (new function)
        let currentCourseData = null; // Store current course globally
        
        function loadCourseContent(course, courseProgress = null) {
            // Store current course data globally
            currentCourseData = course;
            
            // Set current course ID for progress tracking
            currentCourseId = course.id;
            
            // Update course info display
            const courseInfo = document.getElementById('currentCourseInfo');
            courseInfo.innerHTML = `
                <h4>${course.title}</h4>
                <p>${course.description || 'No description available'}</p>
            `;
            
            // Update Learning Progress section with course-specific progress
            if (courseProgress) {
                console.log('Updating Learning Progress with course-specific data:', courseProgress);
                
                // Update time spent
                const timeSpentElement = document.getElementById('timeSpent');
                if (timeSpentElement) {
                    timeSpentElement.textContent = Math.round(courseProgress.time_spent_minutes);
                }
                
                // Update progress percentage
                const progressPercent = Math.round(courseProgress.progress_percentage);
                
                // Update all progress displays
                const progressTextElement = document.getElementById('progressText');
                if (progressTextElement) {
                    progressTextElement.textContent = progressPercent + '%';
                }
                
                const progressFillElement = document.getElementById('progressFill');
                if (progressFillElement) {
                    progressFillElement.style.width = progressPercent + '%';
                }
                
                const videoProgressElement = document.getElementById('videoProgress');
                if (videoProgressElement) {
                    videoProgressElement.textContent = progressPercent + '%';
                }
                
                const videoProgressFillElement = document.getElementById('videoProgressFill');
                if (videoProgressFillElement) {
                    videoProgressFillElement.style.width = progressPercent + '%';
                }
                
                const videoProgressDisplayElement = document.getElementById('videoProgressDisplay');
                if (videoProgressDisplayElement) {
                    videoProgressDisplayElement.textContent = progressPercent + '%';
                }
                
                const progressPercentageElement = document.getElementById('progressPercentage');
                if (progressPercentageElement) {
                    progressPercentageElement.textContent = progressPercent + '%';
                }
            }
            
            // Show course player
            document.getElementById('coursePlayer').style.display = 'block';
            
            // Load video
            const video = document.getElementById('courseVideo');
            if (course.video_url) {
                video.src = course.video_url;
                video.load();
                
                // Initialize progress tracking (don't reset totalWatchTime)
                videoStartTime = null;
                // totalWatchTime = 0; // REMOVED - don't reset accumulated time
                lastUpdateTime = null;
                
                // Initialize watch time from localStorage
                initializeWatchTime();
                
                console.log('Course loaded:', course.title);
            } else {
                video.src = '';
                console.log('No video available for this course');
            }
            
            // Load PDF if available
            if (course.pdf_url) {
                document.getElementById('pdfViewer').src = course.pdf_url;
                document.getElementById('viewPDFBtn').style.display = 'inline-block';
                document.getElementById('downloadPDFBtn').style.display = 'inline-block';
            } else {
                document.getElementById('viewPDFBtn').style.display = 'none';
                document.getElementById('downloadPDFBtn').style.display = 'none';
            }
        }

        // Load courses for dropdown in learning hub
        async function loadCoursesForDropdown() {
            const courseSelect = document.getElementById('courseSelect');
            
            console.log('Loading courses for dropdown. Course select element:', courseSelect);
            
            if (!courseSelect) {
                console.log('Course select element not found');
                return;
            }
            
            // Clear existing options
            courseSelect.innerHTML = '<option value="">Select a course...</option>';
            
            try {
                console.log('Fetching courses from:', `${API_BASE}/courses`);
                const response = await fetch(`${API_BASE}/courses`);
                console.log('Courses API response status:', response.status);
                
                const courses = await response.json();
                console.log('Courses received:', courses);
                
                if (response.ok && courses && courses.length > 0) {
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        courseSelect.appendChild(option);
                    });
                    console.log('Added', courses.length, 'courses to dropdown');
                } else {
                    console.log('No courses found or invalid response, adding sample courses');
                    // Add sample courses for testing
                    addSampleCourses();
                }
            } catch (error) {
                console.error('Error loading courses for dropdown:', error);
                console.log('Adding sample courses due to error');
                // Add sample courses for testing
                addSampleCourses();
            }
        }
        
        // Add sample courses for testing when API fails
        function addSampleCourses() {
            const courseSelect = document.getElementById('courseSelect');
            if (!courseSelect) return;
            
            // Use actual courses from database if API fails
            const sampleCourses = [
                {
                    id: 6,
                    title: 'new sample course',
                    description: 'Sample course with actual video',
                    video_url: '/uploads/44b25927-3dc0-42e5-8361-7de4a49e0e4e_research.mp4',
                    pdf_url: '/uploads/fcda4e8f-8c39-4d9e-8459-03c8943bea92_ai-vs-ml.pdf'
                },
                {
                    id: 7,
                    title: 'MACHINE LEARNING VS DEEP LEARNING MODELS',
                    description: 'Understanding ML vs Deep Learning',
                    video_url: '/uploads/b674d6e9-9542-4705-8831-56f303e136b6_AI VS ML.mp4',
                    pdf_url: '/uploads/fcda4e8f-8c39-4d9e-8459-03c8943bea92_ai-vs-ml.pdf'
                }
            ];
            
            sampleCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                courseSelect.appendChild(option);
            });
            
            // Store sample courses globally for access
            window.sampleCoursesData = sampleCourses;
            console.log('Added', sampleCourses.length, 'sample courses to dropdown');
        }
        
        // Load selected course
        function loadSelectedCourse() {
            const courseSelect = document.getElementById('courseSelect');
            const selectedCourseId = courseSelect.value;
            
            if (!selectedCourseId) {
                return;
            }
            
            // Set current course ID for progress tracking
            currentCourseId = parseInt(selectedCourseId);
            
            // Load course details from API
            loadCourseDetails(parseInt(selectedCourseId));
        }

        // View PDF
        function viewPDF() {
            const pdfContainer = document.getElementById('pdfContainer');
            
            console.log('viewPDF called. currentCourseData:', currentCourseData);
            
            // Use globally stored course data
            if (currentCourseData && currentCourseData.pdf_url) {
                // Show PDF container with animation
                pdfContainer.style.display = 'block';
                pdfContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Load PDF content as text
                loadCoursePDFContent(currentCourseData);
                
                console.log('PDF viewer opened for course:', currentCourseData.title);
            } else {
                console.log('No PDF available. currentCourseData:', currentCourseData);
                alert('No PDF available for this course');
            }
        }
        
        // Load course PDF content as rendered text
        async function loadCoursePDFContent(course) {
            const pdfViewer = document.getElementById('pdfViewer');
            
            try {
                console.log('=== PDF Content Loading Started ===');
                console.log('Loading PDF content for course:', course.title);
                console.log('PDF URL:', course.pdf_url);
                console.log('API_BASE:', API_BASE);
                
                // Show loading state
                pdfViewer.innerHTML = '<div style="padding: 20px; text-align: center;"><p> Loading PDF content...</p></div>';
                
                // Fetch PDF content from backend
                const requestBody = JSON.stringify({
                    pdf_url: course.pdf_url
                });
                
                console.log('Request body:', requestBody);
                console.log('Request URL:', `${API_BASE}/course-pdf-content`);
                
                const response = await fetch(`${API_BASE}/course-pdf-content`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: requestBody
                });
                
                console.log('PDF extraction response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const data = await response.json();
                console.log('PDF extraction response data:', data);
                console.log('Data content length:', data.content ? data.content.length : 'No content');
                
                if (response.ok && data.content && data.content.length > 0) {
                    console.log('=== Rendering PDF Content ===');
                    
                    // Display content exactly like Notes tab
                    const preview = data.content.length > 300 ? 
                        data.content.substring(0, 300) + '...' : 
                        data.content;
                    
                    console.log('Preview text length:', preview.length);
                    
                    const htmlContent = `
                        <div style="padding: 20px;">
                            <div style="background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 1px solid rgba(102, 126, 234, 0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(102, 126, 234, 0.1);">
                                    <h4 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #333;"> ${course.title}</h4>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <span style="color: #666; font-size: 0.8rem;">PDF</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <h5 style="color: #764ba2; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600;"> Summary</h5>
                                </div>
                                
                                <div id="pdf-content-preview" style="color: #444; line-height: 1.6; margin-bottom: 15px; max-height: 200px; overflow-y: auto; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                                    <p>${preview.replace(/\n/g, '<br>')}</p>
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-view" onclick="viewFullPDFContent('${encodeURIComponent(data.content)}')" style="padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                         View Full
                                    </button>
                                    <button class="btn btn-download" onclick="downloadPDF()" style="padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; background: linear-gradient(135deg, #4ade80, #22c55e); color: white;">
                                         Download PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    console.log('Setting HTML content...');
                    pdfViewer.innerHTML = htmlContent;
                    
                    // Store full content for view full function
                    window.currentPDFContent = data.content;
                    
                    console.log('PDF content rendered successfully');
                    console.log('=== PDF Content Loading Complete ===');
                } else {
                    console.log('=== PDF Content Loading Failed ===');
                    console.log('Response ok:', response.ok);
                    console.log('Has content:', !!data.content);
                    console.log('Content length:', data.content ? data.content.length : 0);
                    
                    // Show error message and fallback option
                    pdfViewer.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <p style="color: #dc3545; margin-bottom: 15px;"> ${data.detail || 'Failed to extract PDF content'}</p>
                            <button class="btn btn-primary" onclick="fallbackToIframe('${course.pdf_url}')">
                                 View PDF as Document
                            </button>
                        </div>
                    `;
                    
                    console.log('PDF text extraction failed, showing error:', data.detail);
                }
            } catch (error) {
                console.error('=== PDF Content Loading Error ===');
                console.error('Error loading PDF content:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                // Show error and fallback option
                pdfViewer.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p style="color: #dc3545; margin-bottom: 15px;"> Network error: ${error.message}</p>
                        <button class="btn btn-primary" onclick="fallbackToIframe('${course.pdf_url}')">
                             View PDF as Document
                        </button>
                    </div>
                `;
                
                console.log('Using fallback due to network error');
            }
        }
        
        // View full PDF content (like Notes tab)
        function viewFullPDFContent(encodedContent) {
            const content = decodeURIComponent(encodedContent);
            const previewDiv = document.getElementById('pdf-content-preview');
            
            if (previewDiv) {
                previewDiv.style.maxHeight = 'none';
                previewDiv.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>`;
            }
        }
        
        // Fallback to iframe viewer
        function fallbackToIframe(pdfUrl) {
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.innerHTML = `<iframe src="${pdfUrl}" style="width: 100%; height: 500px; border: none; border-radius: 8px;" frameborder="0"></iframe>`;
            console.log('Using iframe fallback for PDF');
        }
        
        // Close PDF viewer
        function closePDFViewer() {
            const pdfContainer = document.getElementById('pdfContainer');
            const pdfViewer = document.getElementById('pdfViewer');
            
            // Hide container
            pdfContainer.style.display = 'none';
            
            // Clear PDF content (both HTML and src)
            pdfViewer.innerHTML = '';
            pdfViewer.src = '';
            
            console.log('PDF viewer closed');
        }

        // Download PDF
        function downloadPDF() {
            const pdfViewer = document.getElementById('pdfViewer');
            const pdfSrc = pdfViewer.src;
            if (pdfSrc) {
                window.open(pdfSrc, '_blank');
            } else {
                alert('No PDF available for download');
            }
        }

        // Camera functions
        function startCamera() {
            const video = document.getElementById('cameraVideo');
            const trackingStatus = document.getElementById('trackingStatus');
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    // Update tracking status
                    if (trackingStatus) {
                        trackingStatus.textContent = ' Tracking Active';
                        trackingStatus.className = 'status-indicator active';
                    }
                    console.log('Camera and tracking started');
                    
                    // Auto-start tracking after camera is ready
                    setTimeout(() => {
                        startAutoTracking();
                    }, 1000); // Wait 1 second for camera to initialize
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    // Update tracking status to show error
                    if (trackingStatus) {
                        trackingStatus.textContent = ' Camera Error';
                        trackingStatus.className = 'status-indicator error';
                    }
                    // Show user-friendly error message
                    showCameraErrorNotification();
                });
        }
        
        function stopCamera() {
            const video = document.getElementById('cameraVideo');
            const trackingStatus = document.getElementById('trackingStatus');
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            // Update tracking status
            if (trackingStatus) {
                trackingStatus.textContent = ' Tracking Inactive';
                trackingStatus.className = 'status-indicator inactive';
            }
            console.log('Camera and tracking stopped');
        }
        
        // Show camera error notification
        function showCameraErrorNotification() {
            // Create or update notification element
            let notification = document.getElementById('cameraErrorNotification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'cameraErrorNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
                    z-index: 1000;
                    opacity: 0;
                    transform: translateY(-10px);
                    transition: all 0.3s ease;
                    max-width: 300px;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = ' Camera access denied. Using default metrics.';
            
            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
            }, 4000);
        }
        
        // Progress monitoring functions
        let progressInterval = null;
        let videoStartTime = null;
        let totalWatchTime = 0;
        let lastUpdateTime = null;
        
        // Initialize totalWatchTime from localStorage on page load
        function initializeWatchTime() {
            const savedWatchTime = localStorage.getItem('totalWatchTime_' + currentCourseId);
            if (savedWatchTime) {
                totalWatchTime = parseFloat(savedWatchTime);
                console.log('Loaded saved watch time:', totalWatchTime / 60000, 'minutes');
            } else {
                totalWatchTime = 0;
            }
        }
        
        // Save watch time to localStorage
        function saveWatchTime() {
            if (currentCourseId) {
                localStorage.setItem('totalWatchTime_' + currentCourseId, totalWatchTime.toString());
                console.log('Saved watch time:', totalWatchTime / 60000, 'minutes');
            }
        }
        
        function startProgressMonitoring() {
            const video = document.getElementById('courseVideo');
            if (!video) return;
            
            videoStartTime = Date.now();
            lastUpdateTime = Date.now();
            
            // Update progress every second
            progressInterval = setInterval(() => {
                updateVideoProgress();
                updateTimeSpent();
            }, 1000);
            
            console.log('Progress monitoring started');
        }
        
        function stopProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // Update final time
            if (videoStartTime) {
                totalWatchTime += Date.now() - videoStartTime;
                videoStartTime = null;
            }
            
            console.log('Progress monitoring stopped');
        }
        
        function updateVideoProgress() {
            const video = document.getElementById('courseVideo');
            if (!video) return;
            
            const progress = (video.currentTime / video.duration) * 100;
            const progressPercent = Math.round(progress);
            
            // Update progress display
            document.getElementById('progressText').textContent = progressPercent + '%';
            document.getElementById('progressFill').style.width = progressPercent + '%';
            
            // Update video progress bar
            document.getElementById('videoProgress').textContent = progressPercent + '%';
            document.getElementById('videoProgressFill').style.width = progressPercent + '%';
            
            // Update time display
            const currentTime = formatTime(video.currentTime);
            const duration = formatTime(video.duration);
            document.getElementById('videoTime').textContent = `${currentTime} / ${duration}`;
        }
        
        function updateTimeSpent() {
            if (videoStartTime) {
                const currentSessionTime = Date.now() - videoStartTime;
                const totalTime = totalWatchTime + currentSessionTime;
                const minutes = Math.floor(totalTime / 60000);
                
                document.getElementById('timeSpent').textContent = minutes;
            }
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Enhanced chat functions with file upload and notes integration
        let chatFile = null;
        
        function handleChatFileSelect(input) {
            const file = input.files[0];
            const fileInfo = document.getElementById('chatFileInfo');
            
            if (file) {
                chatFile = file;
                fileInfo.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                fileInfo.style.color = '#667eea';
            } else {
                chatFile = null;
                fileInfo.textContent = '';
            }
        }
        
        async function sendChatMessage() {
            const messageInput = document.getElementById('chatMessage');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            // Get selected notes
            const selectedNotes = getSelectedNotes();
            let notesContext = '';
            
            if (selectedNotes.length > 0) {
                // Extract text from selected notes
                notesContext = await extractNotesText(selectedNotes);
            }
            
            // Add user message
            addChatMessage(message, 'user');
            messageInput.value = '';
            
            // Show typing indicator
            addChatMessage(' Thinking...', 'bot', true);
            
            // Send to backend with file and notes context
            await sendToChatbotWithFile(message, notesContext);
        }
        
        async function sendToChatbotWithFile(message, notesContext = '') {
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                
                // Prepare form data for file upload
                const formData = new FormData();
                formData.append('message', message);
                
                // Add file if selected
                if (chatFile) {
                    formData.append('file', chatFile);
                }
                
                // Add student ID
                if (studentId) {
                    formData.append('student_id', studentId);
                }
                
                // Combine message with notes context
                if (notesContext) {
                    const combinedMessage = `Context from my notes:\n${notesContext}\n\nMy question: ${message}`;
                    formData.set('message', combinedMessage);
                }
                
                // Remove typing indicator
                removeTypingIndicator();
                
                const response = await fetch(`${API_BASE}/chatbot`, {
                    method: 'POST',
                    body: formData  // Don't set Content-Type header for FormData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addChatMessage(data.response, 'bot');
                } else {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
                
                // Clear file input after sending
                if (chatFile) {
                    document.getElementById('chatFile').value = '';
                    document.getElementById('chatFileInfo').textContent = '';
                    chatFile = null;
                }
                
            } catch (error) {
                console.error('Error sending message to chatbot:', error);
                removeTypingIndicator();
                addChatMessage('Network error. Please try again.', 'bot');
            }
        }
        
        function addChatMessage(message, sender, isTyping = false) {
            const messagesContainer = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (isTyping) {
                messageDiv.id = 'typing-indicator';
                messageDiv.className = 'message bot-message typing';
            }
            
            const avatar = sender === 'user' ? '' : '';
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <p>${message}</p>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function getSelectedNotes() {
            const checkboxes = document.querySelectorAll('#notesCheckboxList input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }
        
        async function extractNotesText(noteIds) {
            const studentId = parseInt(localStorage.getItem('student_id'));
            let extractedText = '';
            
            for (const noteId of noteIds) {
                try {
                    const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}/content`);
                    const data = await response.json();
                    
                    if (response.ok && data.content) {
                        const note = studentNotes.find(n => n.id === noteId);
                        extractedText += `\n--- ${note?.title || 'Note ' + noteId} ---\n`;
                        extractedText += data.content;
                        extractedText += '\n\n';
                    }
                } catch (error) {
                    console.error('Error extracting note text:', error);
                }
            }
            
            return extractedText;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Handle chat input keypress
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Enhanced video progress functions with real-time tracking and analytics
        let currentCourseId = null;
        let analyticsInterval = null;
        let progressUpdateInterval = null;
        
        function onVideoTimeUpdate() {
            const video = document.getElementById('courseVideo');
            
            // Check if duration is available and update if needed
            if (video.duration && !isNaN(video.duration) && isFinite(video.duration)) {
                const duration = formatTime(video.duration);
                const currentTime = formatTime(video.currentTime);
                
                // Update time display with accurate duration
                const videoTimeElement = document.getElementById('videoTime');
                if (videoTimeElement) {
                    videoTimeElement.textContent = `${currentTime} / ${duration}`;
                }
                
                const videoTimeDisplayElement = document.getElementById('videoTimeDisplay');
                if (videoTimeDisplayElement) {
                    videoTimeDisplayElement.textContent = `${currentTime} / ${duration}`;
                }
                
                const progress = (video.currentTime / video.duration) * 100;
                const progressPercent = Math.round(progress);
                
                // Update progress display in real-time (more frequent updates)
                const videoProgressFillElement = document.getElementById('videoProgressFill');
                if (videoProgressFillElement) {
                    videoProgressFillElement.style.width = progress + '%';
                }
                
                const videoProgressElement = document.getElementById('videoProgress');
                if (videoProgressElement) {
                    videoProgressElement.textContent = progressPercent + '%';
                }
                
                // Update Learning Progress section video progress
                const videoProgressDisplayElement = document.getElementById('videoProgressDisplay');
                if (videoProgressDisplayElement) {
                    videoProgressDisplayElement.textContent = progressPercent + '%';
                }
                
                // Update main course progress in real-time
                const progressTextElement = document.getElementById('progressText');
                if (progressTextElement) {
                    progressTextElement.textContent = progressPercent + '%';
                }
                
                const progressFillElement = document.getElementById('progressFill');
                if (progressFillElement) {
                    progressFillElement.style.width = progressPercent + '%';
                }
                
                // Update dashboard stats in real-time
                const progressElement = document.getElementById('progressPercentage');
                if (progressElement) {
                    progressElement.textContent = progressPercent + '%';
                }
                    
                // Track watch time
                if (videoStartTime && !video.paused) {
                    const now = Date.now();
                    const timeDiff = (now - lastUpdateTime) / 1000; // Convert to seconds
                    totalWatchTime += timeDiff;
                    lastUpdateTime = now;
                    
                    // Periodically save watch time to localStorage (every 30 seconds)
                    if (Math.floor(totalWatchTime / 1000) % 30 === 0) {
                        saveWatchTime();
                    }
                    
                    // Update time spent in Learning Progress (in minutes) - real-time update
                    const timeSpentMinutes = Math.round(totalWatchTime / 60000);
                    document.getElementById('timeSpent').textContent = timeSpentMinutes;
                }
            } else {
                // Duration still not available, show loading state
                const currentTime = formatTime(video.currentTime);
                document.getElementById('videoTime').textContent = `${currentTime} / --:--`;
                document.getElementById('videoTimeDisplay').textContent = `${currentTime} / --:--`;
                
                // Still track watch time even without duration
                if (videoStartTime && !video.paused) {
                    const now = Date.now();
                    const timeDiff = (now - lastUpdateTime) / 1000;
                    totalWatchTime += timeDiff;
                    lastUpdateTime = now;
                    
                    const timeSpentMinutes = Math.round(totalWatchTime / 60000);
                    document.getElementById('timeSpent').textContent = timeSpentMinutes;
                }
            }
        }
        
        function onVideoLoaded() {
            const video = document.getElementById('courseVideo');
            console.log('Video metadata loaded, initial duration:', video.duration);
            
            // Initialize tracking variables (don't reset totalWatchTime)
            videoStartTime = null;
            lastUpdateTime = null;
            // totalWatchTime = 0; // REMOVED - don't reset accumulated time
            
            // Initialize watch time from localStorage
            initializeWatchTime();
            
            // Try to update duration display
            updateVideoDuration();
        }
        
        // Enhanced function to handle video duration updates
        function updateVideoDuration() {
            const video = document.getElementById('courseVideo');
            
            if (video.duration && !isNaN(video.duration) && isFinite(video.duration)) {
                const duration = formatTime(video.duration);
                document.getElementById('videoTime').textContent = `0:00 / ${duration}`;
                document.getElementById('videoTimeDisplay').textContent = `0:00 / ${duration}`;
                console.log('Video duration updated:', video.duration, 'seconds (', duration, ')');
            } else {
                // Duration not available yet, show loading state
                document.getElementById('videoTime').textContent = `0:00 / --:--`;
                document.getElementById('videoTimeDisplay').textContent = `0:00 / --:--`;
                console.log('Video duration not yet available');
            }
        }
        
        // Handle when video data is loaded (more reliable than metadata)
        function onVideoDataLoaded() {
            console.log('Video data loaded, duration:', document.getElementById('courseVideo').duration);
            updateVideoDuration();
        }
        
        // Handle when video duration changes (for streaming videos)
        function onVideoDurationChange() {
            console.log('Video duration changed to:', document.getElementById('courseVideo').duration);
            updateVideoDuration();
        }
        
        // Handle video progress (buffering updates)
        function onVideoProgress() {
            const video = document.getElementById('courseVideo');
            // Check if duration is now available
            if (video.duration && !isNaN(video.duration) && isFinite(video.duration)) {
                updateVideoDuration();
            }
        }
        
        function onVideoPlay() {
            console.log('Video started playing');
            
            if (!videoStartTime) {
                videoStartTime = Date.now();
            }
            lastUpdateTime = Date.now();
            
            // Ensure we have a current course ID before starting analytics
            if (!currentCourseId) {
                currentCourseId = parseInt(localStorage.getItem('selected_course_id'));
            }

            // Start learning analytics
            startLearningAnalytics();

            // Start camera and tracking if not already active
            const cameraVideo = document.getElementById('cameraVideo');
            if (!cameraVideo.srcObject) {
                console.log('Starting camera for learning analytics');
                startCamera();
            } else {
                console.log('Camera already active, starting tracking');
            }
            
            // Start auto tracking
            startAutoTracking();
            
            // Update tracking status to active
            const trackingStatus = document.getElementById('trackingStatus');
            if (trackingStatus) {
                trackingStatus.textContent = ' Tracking Active';
                trackingStatus.className = 'status-indicator active';
            }
        }
        
        function onVideoPause() {
            console.log('Video paused');
            
            const video = document.getElementById('courseVideo');
            const currentVideoProgress = video ? (video.currentTime / video.duration) * 100 : 0;
            console.log('Current video progress on pause:', currentVideoProgress.toFixed(2) + '%');
            
            if (videoStartTime && lastUpdateTime) {
                const timeDiff = (Date.now() - lastUpdateTime) / 1000;
                totalWatchTime += timeDiff;
                lastUpdateTime = null;
            }
            
            // Pause learning analytics
            pauseLearningAnalytics();
            
            // Update database immediately when video is paused
            updateProgressOnPause();
        }
        
        // Update progress immediately when video is paused
        function updateProgressOnPause() {
            if (!currentCourseId) return;
            
            const video = document.getElementById('courseVideo');
            if (!video || !video.duration) return;
            
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            // Validate student ID
            if (!studentId || isNaN(studentId)) {
                console.error('Invalid student ID:', studentId);
                showProgressErrorNotification('Invalid student ID');
                return;
            }
            
            // Calculate current video progress
            const videoProgress = (video.currentTime / video.duration) * 100;
            console.log('Calculated video progress in updateProgressOnPause:', videoProgress.toFixed(2) + '%');
            console.log('Video currentTime:', video.currentTime, 'Video duration:', video.duration);
            
            // Get current metrics for progress update with robust validation
            let gazeScore = 0.75; // Default fallback value
            let faceAttentionScore = 0.75; // Default fallback value
            
            // Safely extract gaze score (handle -- values)
            const gazeMetricElement = document.getElementById('gazeMetric');
            if (gazeMetricElement && gazeMetricElement.textContent) {
                const gazeText = gazeMetricElement.textContent.replace('%', '').replace('--', '0').trim();
                const gazeValue = parseFloat(gazeText);
                if (!isNaN(gazeValue) && isFinite(gazeValue)) {
                    gazeScore = gazeValue / 100;
                }
            }
            
            // Safely extract attention score (handle -- values)
            const attentionMetricElement = document.getElementById('attentionMetric');
            if (attentionMetricElement && attentionMetricElement.textContent) {
                const attentionText = attentionMetricElement.textContent.replace('%', '').replace('--', '0').trim();
                const attentionValue = parseFloat(attentionText);
                if (!isNaN(attentionValue) && isFinite(attentionValue)) {
                    faceAttentionScore = attentionValue / 100;
                }
            }
            
            console.log('Extracted metrics:', {
                gazeScore: gazeScore,
                faceAttentionScore: faceAttentionScore,
                gazeElement: gazeMetricElement?.textContent,
                attentionElement: attentionMetricElement?.textContent
            });
            
            // Calculate time spent in minutes
            const timeSpent = totalWatchTime / 60000; // Convert milliseconds to minutes
            
            // Validate and sanitize data
            const sanitizedData = {
                time_spent: Math.max(0, parseFloat(timeSpent.toFixed(2))), // Ensure non-negative float
                gaze_score: Math.max(0, Math.min(1, parseFloat(gazeScore.toFixed(3)))), // Ensure 0-1 range
                face_attention_score: Math.max(0, Math.min(1, parseFloat(faceAttentionScore.toFixed(3)))) // Ensure 0-1 range
            };
            
            console.log('Updating progress on pause:', {
                videoProgress: videoProgress.toFixed(2) + '%',
                timeSpent: sanitizedData.time_spent + ' min',
                studentId: studentId,
                courseId: currentCourseId,
                totalWatchTimeRaw: totalWatchTime,
                sanitizedData: sanitizedData
            });
            
            // Send immediate update to database
            fetch(`${API_BASE}/students/${studentId}/update_progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sanitizedData)
            })
            .then(response => {
                if (!response.ok) {
                    console.error('HTTP Error:', response.status, response.statusText);
                    return response.text().then(text => {
                        console.error('Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Progress updated on pause:', data);
                
                // Save watch time to localStorage
                saveWatchTime();
                
                // Update Learning Progress section with ACTUAL video progress (not backend progress)
                const progressPercent = Math.round(videoProgress); // Use actual video progress
                
                // Safely update UI elements with null checks
                const progressTextElement = document.getElementById('progressText');
                if (progressTextElement) {
                    progressTextElement.textContent = progressPercent + '%';
                }
                
                const progressFillElement = document.getElementById('progressFill');
                if (progressFillElement) {
                    progressFillElement.style.width = progressPercent + '%';
                }
                
                // Update time spent from database
                const timeSpentMinutes = Math.round(timeSpent);
                const timeSpentElement = document.getElementById('timeSpent');
                if (timeSpentElement) {
                    timeSpentElement.textContent = timeSpentMinutes;
                }
                
                // Update video progress displays
                const videoProgressElement = document.getElementById('videoProgress');
                if (videoProgressElement) {
                    videoProgressElement.textContent = progressPercent + '%';
                }
                
                const videoProgressFillElement = document.getElementById('videoProgressFill');
                if (videoProgressFillElement) {
                    videoProgressFillElement.style.width = progressPercent + '%';
                }
                
                const videoProgressDisplayElement = document.getElementById('videoProgressDisplay');
                if (videoProgressDisplayElement) {
                    videoProgressDisplayElement.textContent = progressPercent + '%';
                }
                
                // Update dashboard stats
                const progressElement = document.getElementById('progressPercentage');
                if (progressElement) {
                    progressElement.textContent = progressPercent + '%';
                }
                
                showProgressSavedNotification();
                
                // Refresh dashboard course cards to show updated progress
                setTimeout(() => {
                    loadStudentCourses(); // Refresh the course cards
                }, 500); // Wait a bit for backend to update
            })
            .catch(error => {
                console.error('Error updating progress on pause:', error);
                // Show error notification
                showProgressErrorNotification(error.message);
            });
        }
        
        // Show notification that progress was saved
        function showProgressSavedNotification() {
            // Create or update notification element
            let notification = document.getElementById('progressSavedNotification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'progressSavedNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #22c55e, #16a34a);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
                    z-index: 1000;
                    opacity: 0;
                    transform: translateY(-10px);
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = ' Progress saved to database';
            
            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            // Hide notification after 2 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
            }, 2000);
        }
        
        // Update course progress cards in dashboard
        function updateCourseProgressCards(progressPercent) {
            // Update course cards in dashboard if they exist
            const courseCards = document.querySelectorAll('.course-card');
            courseCards.forEach(card => {
                const progressBar = card.querySelector('.progress-bar-fill');
                const progressText = card.querySelector('.progress-text');
                const progressPercentage = card.querySelector('.progress-percentage');
                
                if (progressBar) {
                    progressBar.style.width = progressPercent + '%';
                }
                if (progressText) {
                    progressText.textContent = progressPercent + '%';
                }
                if (progressPercentage) {
                    progressPercentage.textContent = progressPercent + '%';
                }
            });
            
            // Update current course card specifically
            const currentCourseCard = document.querySelector('.course-card.active');
            if (currentCourseCard) {
                const cardProgress = currentCourseCard.querySelector('.course-progress');
                if (cardProgress) {
                    cardProgress.textContent = `Progress: ${progressPercent}%`;
                }
            }
        }
        
        // Update all progress indicators throughout the dashboard
        function updateAllProgressIndicators(progressPercent, data) {
            // Update any element with 'progress' in its ID or class
            const progressElements = document.querySelectorAll('[id*="progress"], [class*="progress"]');
            progressElements.forEach(element => {
                if (element.tagName === 'SPAN' || element.tagName === 'DIV') {
                    // Update text content for span/div elements
                    if (element.textContent.includes('%')) {
                        element.textContent = progressPercent + '%';
                    }
                } else if (element.style.width !== undefined) {
                    // Update width for progress bar elements
                    if (element.style.width.includes('%')) {
                        element.style.width = progressPercent + '%';
                    }
                }
            });
            
            // Update specific dashboard elements
            updateDashboardStats(progressPercent, data);
            
            // Update analytics displays
            updateAnalyticsDisplay(data);
        }
        
        // Update dashboard statistics
        function updateDashboardStats(progressPercent, data) {
            // Update main dashboard progress
            const mainProgress = document.getElementById('mainProgress');
            if (mainProgress) {
                mainProgress.textContent = progressPercent + '%';
            }
            
            // Update course completion status
            const completionStatus = document.getElementById('completionStatus');
            if (completionStatus) {
                if (progressPercent === 100) {
                    completionStatus.textContent = 'Completed';
                    completionStatus.className = 'status completed';
                } else if (progressPercent >= 75) {
                    completionStatus.textContent = 'Nearly Complete';
                    completionStatus.className = 'status nearly-complete';
                } else if (progressPercent >= 50) {
                    completionStatus.textContent = 'In Progress';
                    completionStatus.className = 'status in-progress';
                } else {
                    completionStatus.textContent = 'Just Started';
                    completionStatus.className = 'status started';
                }
            }
            
            // Update progress rings or circular indicators
            const progressRings = document.querySelectorAll('.progress-ring, .circular-progress');
            progressRings.forEach(ring => {
                const ringFill = ring.querySelector('.ring-fill, .progress-fill');
                if (ringFill) {
                    ringFill.style.strokeDashoffset = (100 - progressPercent).toString();
                }
            });
        }
        
        // Update analytics display with latest data
        function updateAnalyticsDisplay(data) {
            // Update cognitive load display
            const cognitiveLoadElements = document.querySelectorAll('[id*="cognitive"], [class*="cognitive"]');
            cognitiveLoadElements.forEach(element => {
                if (element.textContent.includes('%')) {
                    element.textContent = Math.round(data.cognitive_load * 100) + '%';
                }
            });
            
            // Update engagement level display
            const engagementElements = document.querySelectorAll('[id*="engagement"], [class*="engagement"]');
            engagementElements.forEach(element => {
                if (element.textContent.includes('%')) {
                    element.textContent = Math.round(data.engagement_level * 100) + '%';
                }
            });
            
            // Update emotional state display
            const emotionalElements = document.querySelectorAll('[id*="emotional"], [class*="emotional"]');
            emotionalElements.forEach(element => {
                if (element.tagName === 'SPAN' || element.tagName === 'DIV') {
                    element.textContent = data.emotional_state || 'neutral';
                }
            });
            
            // Update learning analytics cards
            const analyticsCards = document.querySelectorAll('.analytics-card, .metric-card');
            analyticsCards.forEach(card => {
                const cardTitle = card.querySelector('.card-title, .metric-title');
                const cardValue = card.querySelector('.card-value, .metric-value');
                
                if (cardTitle && cardValue) {
                    const title = cardTitle.textContent.toLowerCase();
                    if (title.includes('cognitive')) {
                        cardValue.textContent = Math.round(data.cognitive_load * 100) + '%';
                    } else if (title.includes('engagement')) {
                        cardValue.textContent = Math.round(data.engagement_level * 100) + '%';
                    } else if (title.includes('progress')) {
                        cardValue.textContent = Math.round(data.new_progress * 100) + '%';
                    }
                }
            });
        }
        
        // Show error notification for progress updates
        function showProgressErrorNotification(errorMessage) {
            // Create or update error notification element
            let notification = document.getElementById('progressErrorNotification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'progressErrorNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                    z-index: 1000;
                    opacity: 0;
                    transform: translateY(-10px);
                    transition: all 0.3s ease;
                    max-width: 300px;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = ` Error: ${errorMessage}`;
            
            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
            }, 3000);
        }
        
        // Learning Analytics Functions
        function startLearningAnalytics() {
            console.log('Starting learning analytics');
            
            // Validate prerequisites
            const studentId = localStorage.getItem('student_id');
            const video = document.getElementById('courseVideo');
            
            if (!studentId) {
                console.error('Cannot start analytics: No student ID found');
                return;
            }
            
            if (!video) {
                console.error('Cannot start analytics: Video element not found');
                return;
            }
            
            if (!currentCourseId) {
                console.error('Cannot start analytics: No course ID available');
                return;
            }
            
            // Stop any existing analytics intervals
            stopLearningAnalytics();
            
            console.log('Analytics prerequisites validated:', {
                studentId: studentId,
                courseId: currentCourseId,
                videoDuration: video.duration,
                videoReady: video.readyState >= 2
            });
            
            // Start periodic analytics updates
            analyticsInterval = setInterval(() => {
                updateLearningAnalytics();
            }, 3000); // Update every 3 seconds
            
            // Start progress updates
            progressUpdateInterval = setInterval(() => {
                updateProgressFromVideo();
            }, 5000); // Update progress every 5 seconds
            
            console.log('Learning analytics started successfully');
            
            // Show analytics started notification (optional)
            showAnalyticsStartedNotification();
        }
        
        // Show notification that analytics has started
        function showAnalyticsStartedNotification() {
            // Create or update notification element
            let notification = document.getElementById('analyticsStartedNotification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'analyticsStartedNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 20px;
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                    z-index: 1000;
                    opacity: 0;
                    transform: translateY(-10px);
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = ' Learning analytics started';
            
            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            // Hide notification after 2 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
            }, 2000);
        }
        
        function pauseLearningAnalytics() {
            console.log('Pausing learning analytics');
            
            // Stop camera tracking
            stopAutoTracking();
            
            // Stop camera stream
            stopCamera();
            
            // Clear analytics intervals
            if (analyticsInterval) {
                clearInterval(analyticsInterval);
                analyticsInterval = null;
            }
            
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
                progressUpdateInterval = null;
            }
            
            // Update tracking status to inactive
            const trackingStatus = document.getElementById('trackingStatus');
            if (trackingStatus) {
                trackingStatus.textContent = ' Tracking Paused';
                trackingStatus.className = 'status-indicator inactive';
            }
        }
        
        function stopLearningAnalytics() {
            console.log('Stopping learning analytics');
            
            if (analyticsInterval) {
                clearInterval(analyticsInterval);
                analyticsInterval = null;
            }
            
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
                progressUpdateInterval = null;
            }
        }
        
        // Update progress from video
        function updateProgressFromVideo() {
            const video = document.getElementById('courseVideo');
            if (!video || !video.duration) return;
            
            const progress = (video.currentTime / video.duration) * 100;
            autoUpdateProgress(progress);
        }
        
        function onVideoCompleted() {
            console.log('Video completed');
            
            // Mark video as completed and update progress
            const video = document.getElementById('courseVideo');
            const finalProgress = 100; // Video completed
            
            // Update total watch time
            if (videoStartTime && lastUpdateTime) {
                const timeDiff = (Date.now() - lastUpdateTime) / 1000;
                totalWatchTime += timeDiff;
            }
            
            // Stop learning analytics
            stopLearningAnalytics();
            
            // Auto-update progress to 100% with realistic metrics
            const studentId = parseInt(localStorage.getItem('student_id'));
            if (studentId && currentCourseId) {
                // Calculate time spent in minutes
                const timeSpent = totalWatchTime / 60000;
                
                // Use realistic metrics for course completion
                const completionData = {
                    time_spent: Math.max(1.0, parseFloat(timeSpent.toFixed(2))), // At least 1 minute
                    gaze_score: 0.85, // Good attention for completed course
                    face_attention_score: 0.90 // High engagement for completed course
                };
                
                console.log('Course completion data:', completionData);
                
                // Send completion update to backend
                fetch(`${API_BASE}/students/${studentId}/update_progress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(completionData)
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('Error updating course completion:', response.status);
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Course completion updated:', data);
                    
                    // Update UI with completion status
                    if (document.getElementById('progressText')) {
                        document.getElementById('progressText').textContent = '100%';
                    }
                    if (document.getElementById('progressFill')) {
                        document.getElementById('progressFill').style.width = '100%';
                    }
                    
                    // Refresh dashboard course cards to show updated progress
                    setTimeout(() => {
                        loadStudentCourses(); // Refresh the course cards
                    }, 1000); // Wait a bit for backend to update
                    
                    // Show completion message
                    alert(' Course completed! Your progress has been updated.');
                })
                .catch(error => {
                    console.error('Error in course completion:', error);
                    alert('Course completed but there was an error updating progress.');
                });
            }
            
            // Save watch time to localStorage
            saveWatchTime();
        }
        
        // Enhanced autoUpdateProgress function
        function autoUpdateProgress(progress, isCompleted = false) {
            if (!currentCourseId) return;
            
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            // Validate student ID
            if (!studentId || isNaN(studentId)) {
                console.error('Invalid student ID in autoUpdateProgress:', studentId);
                return;
            }
            
            // Get current metrics for progress update with robust validation
            let gazeScore = 0.75; // Default fallback value
            let faceAttentionScore = 0.75; // Default fallback value
            
            // Safely extract gaze score
            const gazeMetricElement = document.getElementById('gazeMetric');
            if (gazeMetricElement && gazeMetricElement.textContent) {
                const gazeText = gazeMetricElement.textContent.replace('%', '').trim();
                const gazeValue = parseFloat(gazeText);
                if (!isNaN(gazeValue) && isFinite(gazeValue)) {
                    gazeScore = gazeValue / 100;
                }
            }
            
            // Safely extract attention score
            const attentionMetricElement = document.getElementById('attentionMetric');
            if (attentionMetricElement && attentionMetricElement.textContent) {
                const attentionText = attentionMetricElement.textContent.replace('%', '').trim();
                const attentionValue = parseFloat(attentionText);
                if (!isNaN(attentionValue) && isFinite(attentionValue)) {
                    faceAttentionScore = attentionValue / 100;
                }
            }
            
            // Calculate time spent in minutes
            const timeSpent = totalWatchTime / 60000; // Convert milliseconds to minutes
            
            // Validate and sanitize data
            const sanitizedData = {
                time_spent: Math.max(0, parseFloat(timeSpent.toFixed(2))), // Ensure non-negative float
                gaze_score: Math.max(0, Math.min(1, parseFloat(gazeScore.toFixed(3)))), // Ensure 0-1 range
                face_attention_score: Math.max(0, Math.min(1, parseFloat(faceAttentionScore.toFixed(3)))) // Ensure 0-1 range
            };
            
            fetch(`${API_BASE}/students/${studentId}/update_progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sanitizedData)
            })
            .then(response => {
                if (!response.ok) {
                    console.error('HTTP Error in autoUpdateProgress:', response.status, response.statusText);
                    return response.text().then(text => {
                        console.error('Error response body:', text);
                    });
                    return; // Don't throw error here to avoid breaking the flow
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log('Progress updated:', data);
                    
                    // Use the actual progress parameter passed to this function, not backend response
                    const progressPercent = Math.round(progress); // Use actual video progress
                    
                    // Safely update UI elements with null checks
                    const progressTextElement = document.getElementById('progressText');
                    if (progressTextElement) {
                        progressTextElement.textContent = progressPercent + '%';
                    }
                    
                    const progressFillElement = document.getElementById('progressFill');
                    if (progressFillElement) {
                        progressFillElement.style.width = progressPercent + '%';
                    }
                    
                    // Update time spent from database
                    const timeSpentMinutes = Math.round(timeSpent);
                    const timeSpentElement = document.getElementById('timeSpent');
                    if (timeSpentElement) {
                        timeSpentElement.textContent = timeSpentMinutes;
                    }
                    
                    // Update dashboard stats if available
                    const progressElement = document.getElementById('progressPercentage');
                    if (progressElement) {
                        progressElement.textContent = progressPercent + '%';
                    }
                    
                    const cognitiveElement = document.getElementById('cognitiveLevel');
                    if (cognitiveElement) {
                        cognitiveElement.textContent = Math.round(data.cognitive_load * 100) + '%';
                    }
                    
                    // Update progress display
                    if (isCompleted) {
                        document.getElementById('videoProgress').textContent = '100%';
                        document.getElementById('videoProgressFill').style.width = '100%';
                        document.getElementById('videoProgressDisplay').textContent = '100%';
                    }
                }
            })
            .catch(error => {
                console.error('Error updating progress:', error);
            });
            
            // Refresh dashboard course cards periodically during video playback
            if (!isCompleted && progress > 0 && progress % 25 < 5) { // Every ~25% progress
                setTimeout(() => {
                    loadStudentCourses(); // Refresh the course cards
                }, 200);
            }
        }
        
        // Add event listener to automatically load course when learning tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced tab switching to auto-load courses, notes, and chat notes
            const originalShowTab = window.showTab;
            window.showTab = function(tabName) {
                originalShowTab(tabName);
                
                // Auto-load current course when switching to learning tab
                if (tabName === 'learning') {
                    setTimeout(() => {
                        loadCurrentCourse();
                    }, 100); // Small delay to ensure tab is visible
                }
                
                // Auto-refresh notes when switching to notes tab
                if (tabName === 'notes') {
                    setTimeout(() => {
                        loadMyNotes();
                    }, 100); // Small delay to ensure tab is visible
                }
                
                // Auto-refresh chat notes dropdown when switching to AI Assistant tab
                if (tabName === 'chatbot') {
                    setTimeout(() => {
                        loadChatNotesDropdown();
                    }, 100); // Small delay to ensure tab is visible
                }
            };
            
            // Auto-load course on page load if learning tab is active
            if (document.getElementById('learning').classList.contains('active')) {
                loadCurrentCourse();
            }
            
            // Auto-load notes on page load if notes tab is active
            if (document.getElementById('notes').classList.contains('active')) {
                loadMyNotes();
            }
            
            // Auto-load chat notes on page load if AI Assistant tab is active
            if (document.getElementById('chatbot').classList.contains('active')) {
                loadChatNotesDropdown();
            }
        });
        
        // Add event listeners for password checking
        
        // Load and display current user's notes
        async function loadMyNotes() {
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            if (!studentId) {
                alert('Please login to view your notes');
                return;
            }
            
            const loadingDiv = document.getElementById('notes-loading');
            const displayDiv = document.getElementById('myNotesDisplay');
            const notesListDiv = document.getElementById('notesListDisplay');
            
            // Show loading
            loadingDiv.style.display = 'block';
            displayDiv.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/notes`);
                const notes = await response.json();
                
                if (response.ok) {
                    studentNotes = notes;
                    displayMyNotes(notes);
                } else {
                    notesListDiv.innerHTML = `
                        <div class="no-notes">
                            <h4> No Notes Found</h4>
                            <p>You haven't uploaded any notes yet. Upload your first note above!</p>
                        </div>
                    `;
                    displayDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading notes:', error);
                notesListDiv.innerHTML = `
                    <div class="no-notes">
                        <h4> Error Loading Notes</h4>
                        <p>There was an error loading your notes. Please try again.</p>
                    </div>
                `;
                displayDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // Display notes in readable format
        function displayMyNotes(notes) {
            const displayDiv = document.getElementById('myNotesDisplay');
            const notesListDiv = document.getElementById('notesListDisplay');
            
            if (notes.length === 0) {
                notesListDiv.innerHTML = `
                    <div class="no-notes">
                        <h4> No Notes Found</h4>
                        <p>You haven't uploaded any notes yet. Upload your first note above!</p>
                    </div>
                `;
            } else {
                notesListDiv.innerHTML = notes.map(note => `
                    <div class="note-item" data-note-id="${note.id}">
                        <div class="note-header">
                            <div class="note-title">${note.title || 'Untitled Note'}</div>
                            <div class="note-meta">
                                <span class="note-type-badge">${note.file_type ? note.file_type.toUpperCase() : 'TXT'}</span>
                                <span class="note-date">${new Date(note.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        
                        ${note.summary ? `
                            <div class="note-summary">
                                <h5> Summary</h5>
                                <p>${note.summary}</p>
                            </div>
                        ` : ''}
                        
                        <div class="note-content" id="note-content-${note.id}">
                            <p><em>Loading content...</em></p>
                        </div>
                        
                        <div class="note-actions">
                            <button class="btn btn-view" onclick="viewNoteContent(${note.id})"> View Full</button>
                            <button class="btn btn-download" onclick="downloadNote(${note.id})"> Download</button>
                            <button class="btn btn-delete" onclick="deleteNote(${note.id})"> Delete</button>
                        </div>
                    </div>
                `).join('');
                
                // Load content for each note
                notes.forEach(note => {
                    loadNoteContent(note.id);
                });
            }
            
            displayDiv.style.display = 'block';
        }
        
        // Load individual note content
        async function loadNoteContent(noteId) {
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}/content`);
                const data = await response.json();
                
                if (response.ok && data.content) {
                    const contentDiv = document.getElementById(`note-content-${noteId}`);
                    if (contentDiv) {
                        // Truncate content for preview
                        const preview = data.content.length > 300 ? 
                            data.content.substring(0, 300) + '...' : 
                            data.content;
                        contentDiv.innerHTML = `<p>${preview.replace(/\n/g, '<br>')}</p>`;
                    }
                }
            } catch (error) {
                console.error('Error loading note content:', error);
            }
        }
        
        // View full note content
        async function viewNoteContent(noteId) {
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}/content`);
                const data = await response.json();
                
                if (response.ok && data.content) {
                    const note = studentNotes.find(n => n.id === noteId);
                    const contentDiv = document.getElementById(`note-content-${noteId}`);
                    
                    if (contentDiv) {
                        contentDiv.style.maxHeight = 'none';
                        contentDiv.innerHTML = `
                            <h5> Full Content</h5>
                            <p>${data.content.replace(/\n/g, '<br>')}</p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error viewing note:', error);
                alert('Error loading note content');
            }
        }
        
        // Download note
        async function downloadNote(noteId) {
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                window.open(`${API_BASE}/students/${studentId}/notes/${noteId}/download`, '_blank');
            } catch (error) {
                console.error('Error downloading note:', error);
                alert('Error downloading note');
            }
        }
        
        // Delete note
        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove note from display
                    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        noteElement.remove();
                    }
                    
                    // Refresh notes list
                    await loadMyNotes();
                    
                    // Also refresh chat notes dropdown
                    loadChatNotesDropdown();
                } else {
                    alert('Error deleting note');
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Error deleting note');
            }
        }
        
        // Update uploadNote function to refresh notes after upload
        async function uploadNote() {
            // ... existing upload code ...
            
            // After successful upload, refresh notes display
            await loadMyNotes();
        }
        let studentNotes = [];
        
        function handleNoteFileSelect(input) {
            const file = input.files[0];
            const fileInfo = document.getElementById('noteFileInfo');
            
            if (file) {
                fileInfo.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                fileInfo.style.color = '#667eea';
            } else {
                fileInfo.textContent = '';
            }
        }
        
        async function uploadNotes() {
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            // Try both possible input IDs
            let fileInput = document.getElementById('note-file') || document.getElementById('noteFile');
            
            if (!studentId) {
                alert('Please login to upload notes');
                return;
            }
            
            if (!fileInput.files[0]) {
                alert('Please select a file to upload');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('student_id', studentId);
            
            try {
                document.getElementById('notes-loading').style.display = 'block';
                
                const response = await fetch(`${API_BASE}/students/${studentId}/upload_notes`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Note uploaded successfully!');
                    // Clear file input
                    fileInput.value = '';
                    // Reload notes in both places
                    loadMyNotes();
                    // Also refresh chat dropdown
                    loadChatNotesDropdown();
                } else {
                    alert('Error uploading note: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error uploading note:', error);
                alert('Error uploading note: ' + error.message);
            } finally {
                document.getElementById('notes-loading').style.display = 'none';
            }
        }
        
        // Notes Chat Functions
        
        async function loadStudentNotes() {
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            if (!studentId) {
                console.log('Student ID not found');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/notes`);
                const notes = await response.json();
                
                if (response.ok) {
                    studentNotes = notes;
                    displayNotes(notes);
                    updateNotesSelection(notes);
                } else {
                    console.error('Failed to load notes');
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }
        
        function displayNotes(notes) {
            const notesList = document.getElementById('notesList');
            
            if (!notes || notes.length === 0) {
                notesList.innerHTML = '<div class="notes-placeholder"><p>Upload notes to get started</p></div>';
                return;
            }
            
            const notesHtml = notes.map(note => `
                <div class="note-item" style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #333;">${note.title || 'Untitled Note'}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">Type: ${note.file_path.endsWith('.pdf') ? 'PDF' : 'Text'}</p>
                            <p style="margin: 5px 0 0 0; color: #999; font-size: 0.8rem;">Uploaded: ${new Date(note.created_at).toLocaleString()}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="viewNote(${note.id})"> View</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNote(${note.id})"> Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            notesList.innerHTML = notesHtml;
        }
        
        function updateNotesSelection(notes) {
            const notesCheckboxList = document.getElementById('notesCheckboxList');
            
            if (!notes || notes.length === 0) {
                notesCheckboxList.innerHTML = '<p style="color: #666; font-size: 0.9rem;">Upload notes first to include them in your questions</p>';
                return;
            }
            
            const checkboxHtml = notes.map(note => `
                <div class="note-checkbox-item">
                    <input type="checkbox" id="note-${note.id}" value="${note.id}">
                    <label for="note-${note.id}">${note.title || 'Untitled Note'}</label>
                    <span class="note-type">${note.file_path.endsWith('.pdf') ? 'PDF' : 'TXT'}</span>
                </div>
            `).join('');
            
            notesCheckboxList.innerHTML = checkboxHtml;
        }
        
        async function viewNote(noteId) {
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}/content`);
                const data = await response.json();
                
                if (response.ok) {
                    // Create a modal to display the note content
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
                    `;
                    
                    const content = document.createElement('div');
                    content.style.cssText = `
                        background: white; padding: 30px; border-radius: 15px; max-width: 80%; max-height: 80%; overflow-y: auto;
                    `;
                    
                    content.innerHTML = `
                        <h3 style="margin: 0 0 20px 0;"> Note Content</h3>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;">
                            ${data.content}
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px;" class="btn btn-secondary">Close</button>
                    `;
                    
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                } else {
                    alert('Failed to load note content');
                }
            } catch (error) {
                console.error('Error viewing note:', error);
                alert('Error viewing note: ' + error.message);
            }
        }
        
        async function deleteNote(noteId) {
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    console.log('Note deleted successfully');
                    await loadStudentNotes();
                } else {
                    alert('Failed to delete note');
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Error deleting note: ' + error.message);
            }
        }
        
        async function loadNotes() {
            const studentId = document.getElementById('view-notes-student-id').value;
            const resultsDiv = document.getElementById('notes-results');
            
            resultsDiv.innerHTML = '<p>Loading notes...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/notes`);
                const notes = await response.json();
                
                if (response.ok) {
                    if (notes.length === 0) {
                        resultsDiv.innerHTML = '<p>No notes found for this student.</p>';
                    } else {
                        resultsDiv.innerHTML = notes.map(note => `
                            <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                <h4 style="margin: 0 0 10px 0; color: #333;">Note ID: ${note.id}</h4>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">File: ${note.file_path}</p>
                                <p style="margin: 5px 0; color: #667eea; font-size: 0.8rem;">Summary: ${note.summary || 'No summary available'}</p>
                            </div>
                        `).join('');
                    }
                } else {
                    resultsDiv.innerHTML = '<p>Failed to load notes.</p>';
                }
            } catch (error) {
                console.error('Error loading notes:', error);
                resultsDiv.innerHTML = '<p>Error loading notes: ' + error.message + '</p>';
            }
        }
        
        // Notes Chat Functions
        // studentNotes variable already declared above at line 2315
        
        // Load student notes for chat selection
        async function loadChatNotes() {
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                if (!studentId) {
                    document.getElementById('chatNotesList').innerHTML = '<p style="color: #666; text-align: center;">Please login to access notes</p>';
                    return;
                }
                
                const response = await fetch(`${API_BASE}/students/${studentId}/notes`);
                const data = await response.json();
                
                if (response.ok && data.notes) {
                    studentNotes = data.notes;
                    displayChatNotes();
                } else {
                    document.getElementById('chatNotesList').innerHTML = '<p style="color: #666; text-align: center;">No notes available. Upload some notes first!</p>';
                }
            } catch (error) {
                console.error('Error loading chat notes:', error);
                document.getElementById('chatNotesList').innerHTML = '<p style="color: #999; text-align: center;">Error loading notes</p>';
            }
        }
        
        // Display notes in chat selection
        function displayChatNotes() {
            const notesList = document.getElementById('chatNotesList');
            
            if (studentNotes.length === 0) {
                notesList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No notes available. Upload some notes first!</p>';
                return;
            }
            
            notesList.innerHTML = studentNotes.map(note => `
                <div class="note-checkbox-item" data-note-id="${note.id}">
                    <input type="checkbox" id="chat-note-${note.id}" value="${note.id}">
                    <label for="chat-note-${note.id}">
                        <span>${note.title || 'Untitled Note'}</span>
                        <span class="note-type">${note.file_type ? note.file_type.toUpperCase() : 'TXT'}</span>
                    </label>
                </div>
            `).join('');
            
            // Add click handlers for checkbox items
            document.querySelectorAll('.notes-chat-selection .note-checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                // Toggle selected class on checkbox change
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
                
                // Also toggle when clicking the item (except checkbox)
                item.addEventListener('click', function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
            });
        }
        
        // Add selected notes to chat context
        async function addSelectedNotesToChat() {
            const selectedCheckboxes = document.querySelectorAll('#chatNotesList input[type="checkbox"]:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one note to add to chat');
                return;
            }
            
            const selectedNoteIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            let notesContext = '';
            
            // Extract text from selected notes
            for (const noteId of selectedNoteIds) {
                try {
                    const studentId = parseInt(localStorage.getItem('student_id'));
                    const response = await fetch(`${API_BASE}/students/${studentId}/notes/${noteId}/content`);
                    const data = await response.json();
                    
                    if (response.ok && data.content) {
                        const note = studentNotes.find(n => n.id === noteId);
                        notesContext += `\n--- ${note?.title || 'Note ' + noteId} ---\n`;
                        notesContext += data.content;
                        notesContext += '\n\n';
                    }
                } catch (error) {
                    console.error('Error extracting note text:', error);
                }
            }
            
            // Add notes to context field
            const contextInput = document.getElementById('chat-context');
            const currentContext = contextInput.value.trim();
            
            if (currentContext) {
                contextInput.value = currentContext + '\n\n' + notesContext;
            } else {
                contextInput.value = notesContext;
            }
            
            // Clear selections
            selectedCheckboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('.note-checkbox-item').classList.remove('selected');
            });
            
            // Show success message
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = ' Notes Added to Context!';
            button.style.background = 'linear-gradient(135deg, #4ade80, #22c55e)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }
        
        // Update showTab function to load notes when chatbot tab is opened
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            if (event && event.target) {
                event.target.closest('.tab-btn').classList.add('active');
            }
            
            // Load tab-specific data
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'learning') {
                // Load courses for dropdown
                loadCoursesForDropdown();
                
                // Check if there's a selected course to load
                const selectedCourseId = localStorage.getItem('selected_course_id');
                if (selectedCourseId) {
                    loadCourseDetails(parseInt(selectedCourseId));
                    // Clear the stored course ID after loading
                    localStorage.removeItem('selected_course_id');
                }
            } else if (tabName === 'chatbot') {
                // Load notes dropdown when chatbot tab is opened
                loadChatNotesDropdown();
            }
        }
        
        // Handle chat file selection
        function handleChatFileSelect(input) {
            const file = input.files[0];
            const fileInfo = document.getElementById('chat-file-info');
            
            if (file) {
                const fileSize = formatFileSize(file.size);
                fileInfo.innerHTML = `
                    <span class="file-name"> ${file.name}</span>
                    <span class="file-size">(${fileSize})</span>
                    <button class="remove-file" onclick="removeChatFile()"></button>
                `;
                fileInfo.style.display = 'block';
            } else {
                fileInfo.style.display = 'none';
            }
        }
        
        // Remove chat file
        function removeChatFile() {
            const fileInput = document.getElementById('chat-file-upload');
            const fileInfo = document.getElementById('chat-file-info');
            
            fileInput.value = '';
            fileInfo.style.display = 'none';
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        function sendChatMessage() {
            const messageInput = document.getElementById('chat-message');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Please enter a question');
                return;
            }
            
            // Get context from the hidden context field (notes are optional)
            const contextInput = document.getElementById('chat-context');
            const context = contextInput ? contextInput.value.trim() : '';
            
            // Use the new conversation-preserving function
            sendChatMessageWithContext(message, context);
        }
        
        async function sendChatToBackend(message, context) {
            try {
                const studentId = parseInt(localStorage.getItem('student_id'));
                
                const formData = new FormData();
                formData.append('message', message);
                formData.append('context', context);
                formData.append('student_id', studentId);
                
                // Add file if selected
                const fileInput = document.getElementById('chat-file-upload');
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
                
                const response = await fetch(`${API_BASE}/chatbot`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateChatResponse(message, data.response);
                } else {
                    updateChatResponse(message, 'Sorry, I could not process your request. Please try again.');
                }
            } catch (error) {
                console.error('Chat error:', error);
                updateChatResponse(message, 'Network error. Please check your connection and try again.');
            } finally {
                document.getElementById('chat-loading').style.display = 'none';
                // Clear file after sending
                removeChatFile();
            }
        }
        
        function updateChatResponse(userMessage, aiResponse) {
            const responseArea = document.getElementById('chat-response');
            
            // Format AI response with better structure
            const formattedResponse = formatAIResponse(aiResponse);
            
            // Find the last AI message and update it instead of replacing everything
            const aiMessages = responseArea.querySelectorAll('.ai-message');
            const lastAiMessage = aiMessages[aiMessages.length - 1];
            
            if (lastAiMessage) {
                // Update the last AI message content
                lastAiMessage.innerHTML = `
                    <div class="message-avatar ai-avatar"></div>
                    <div class="message-content">
                        <div class="message-header">AI Assistant</div>
                        <div class="message-text">${formattedResponse}</div>
                    </div>
                `;
            } else {
                // Fallback: if no AI message found, append a new one
                const newMessageHtml = `
                    <div class="chat-message-container">
                        <div class="user-message">
                            <div class="message-avatar user-avatar"></div>
                            <div class="message-content">
                                <div class="message-header">You</div>
                                <div class="message-text">${userMessage}</div>
                            </div>
                        </div>
                        
                        <div class="ai-message">
                            <div class="message-avatar ai-avatar"></div>
                            <div class="message-content">
                                <div class="message-header">AI Assistant</div>
                                <div class="message-text">${formattedResponse}</div>
                            </div>
                        </div>
                    </div>
                `;
                responseArea.innerHTML += newMessageHtml;
            }
            
            // Scroll to bottom to show the latest message
            responseArea.scrollTop = responseArea.scrollHeight;
        }
        
        // Clear chat history function
        function clearChatHistory() {
            if (confirm('Are you sure you want to clear the entire chat history?')) {
                const responseArea = document.getElementById('chat-response');
                responseArea.innerHTML = 'AI responses based on your notes will appear here...';
                
                // Also clear any selected notes
                clearChatNoteSelection();
                
                console.log('Chat history cleared');
            }
        }
        
        function formatAIResponse(response) {
            // Format numbered lists
            response = response.replace(/(\d+\.\s*\*\*([^*]+)\*\*:)/g, '<div class="list-item"><span class="list-number">$1</span><span class="list-title">$2</span></div>');
            
            // Format bold text
            response = response.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Format bullet points
            response = response.replace(/\*\s*([^*\n]+)/g, '<div class="bullet-point"> $1</div>');
            
            // Add line breaks for better readability
            response = response.replace(/\n\n/g, '</div><div class="response-section">');
            response = '<div class="response-section">' + response + '</div>';
            
            return response;
        }
        
        function sendQuickQuestion(question) {
            const messageInput = document.getElementById('chat-message');
            messageInput.value = question;
            sendChatMessage();
        }
        
        // Chat Notes Dropdown Functions
        let selectedChatNote = null;
        
        // Load notes into chat dropdown when chatbot tab is opened
        function loadChatNotesDropdown() {
            const studentId = parseInt(localStorage.getItem('student_id'));
            const notesSelect = document.getElementById('chat-notes-select');
            
            console.log('Loading chat notes dropdown. Student ID:', studentId, 'Notes select element:', notesSelect);
            
            if (!studentId || !notesSelect) {
                console.log('Missing student ID or notes select element');
                return;
            }
            
            // Clear existing options except the default
            notesSelect.innerHTML = '<option value=""> Select a note to include...</option>';
            
            // Load user's notes
            fetch(`${API_BASE}/students/${studentId}/notes`)
                .then(response => {
                    console.log('Notes API response status:', response.status);
                    return response.json();
                })
                .then(notes => {
                    console.log('Notes received:', notes);
                    if (notes && notes.length > 0) {
                        notes.forEach(note => {
                            const option = document.createElement('option');
                            option.value = note.id;
                            const fileName = note.summary || `Note ${note.id}`;
                            const fileType = note.file_path.endsWith('.pdf') ? 'PDF' : 'TXT';
                            option.textContent = `${fileName} (${fileType})`;
                            notesSelect.appendChild(option);
                        });
                        console.log('Added', notes.length, 'notes to dropdown');
                    } else {
                        console.log('No notes found for student');
                    }
                })
                .catch(error => {
                    console.error('Error loading notes for dropdown:', error);
                });
        }
        
        // Handle note selection from dropdown
        function handleChatNoteSelection() {
            const notesSelect = document.getElementById('chat-notes-select');
            const noteInfo = document.getElementById('chat-note-info');
            
            if (notesSelect.value) {
                selectedChatNote = notesSelect.value;
                const selectedOption = notesSelect.options[notesSelect.selectedIndex];
                const noteName = selectedOption.textContent;
                
                // Show selected note info
                noteInfo.innerHTML = `
                    <span class="note-name"> ${noteName}</span>
                    <button class="remove-note" onclick="clearChatNoteSelection()" title="Remove note"></button>
                `;
                noteInfo.style.display = 'flex';
            } else {
                clearChatNoteSelection();
            }
        }
        
        // Clear selected note
        function clearChatNoteSelection() {
            selectedChatNote = null;
            const notesSelect = document.getElementById('chat-notes-select');
            const noteInfo = document.getElementById('chat-note-info');
            
            if (notesSelect) {
                notesSelect.value = '';
            }
            
            if (noteInfo) {
                noteInfo.style.display = 'none';
            }
        }
        
        // Modify sendChatMessage to include selected note
        function sendChatMessageWithNote() {
            const messageInput = document.getElementById('chat-message');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Please enter a question');
                return;
            }
            
            let context = '';
            
            // If a note is selected, load its content as context
            if (selectedChatNote) {
                const studentId = parseInt(localStorage.getItem('student_id'));
                
                fetch(`${API_BASE}/students/${studentId}/notes/${selectedChatNote}/content`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.content) {
                            context = data.content;
                        }
                        // Send message with context
                        sendChatMessageWithContext(message, context);
                    })
                    .catch(error => {
                        console.error('Error loading note content:', error);
                        // Send message without note content if there's an error
                        sendChatMessageWithContext(message, context);
                    });
            } else {
                // Send message without note content
                sendChatMessageWithContext(message, context);
            }
        }
        
        // Send chat message with context
        function sendChatMessageWithContext(message, context) {
            const responseArea = document.getElementById('chat-response');
            
            // Clear the placeholder text on first message
            if (responseArea.innerHTML.includes('AI responses based on your notes will appear here...')) {
                responseArea.innerHTML = '';
            }
            
            // Add user message to response area
            const userMessageHtml = `
                <div class="chat-message-container">
                    <div class="user-message">
                        <div class="message-avatar user-avatar"></div>
                        <div class="message-content">
                            <div class="message-header">You</div>
                            <div class="message-text">${message}</div>
                        </div>
                    </div>
                    
                    <div class="ai-message">
                        <div class="message-avatar ai-avatar"></div>
                        <div class="message-content">
                            <div class="message-header">AI Assistant</div>
                            <div class="message-text">${context ? 'Analyzing your selected note...' : 'Processing your question...'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append the new message instead of replacing
            responseArea.innerHTML += userMessageHtml;
            
            // Show loading
            document.getElementById('chat-loading').style.display = 'block';
            
            // Send to backend
            sendChatToBackend(message, context);
            
            // Clear input
            document.getElementById('chat-message').value = '';
            
            // Clear selected note after sending
            clearChatNoteSelection();
        }
        
        // Additional notes functions
        async function viewNote(noteId) {
            try {
                const response = await fetch(`${API_BASE}/notes/${noteId}`);
                const note = await response.json();
                
                if (response.ok) {
                    window.open(note.file_path, '_blank');
                } else {
                    alert('Failed to view note');
                }
            } catch (error) {
                console.error('Error viewing note:', error);
                alert('Error viewing note: ' + error.message);
            }
        }
        
        async function downloadNote(noteId) {
            try {
                const response = await fetch(`${API_BASE}/notes/${noteId}/download`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `note_${noteId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download note');
                }
            } catch (error) {
                console.error('Error downloading note:', error);
                alert('Error downloading note: ' + error.message);
            }
        }
        
        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/notes/${noteId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Note deleted successfully!');
                    loadNotes(); // Refresh notes list
                } else {
                    alert('Failed to delete note');
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Error deleting note: ' + error.message);
            }
        }
        
        // Course enrollment function
        async function enrollInCourse(courseId) {
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/enroll`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_id: courseId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Successfully enrolled in course!');
                    loadStudentCourses(); // Refresh courses
                } else {
                    alert('Failed to enroll: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error enrolling in course:', error);
                alert('Error enrolling in course: ' + error.message);
            }
        }
        
        // Analyze frame for learning analytics
        async function analyzeFrame() {
            const video = document.getElementById('cameraVideo');
            const studentId = parseInt(localStorage.getItem('student_id'));
            
            if (!studentId || !video.srcObject) {
                console.log('Cannot analyze frame: missing student ID or camera stream');
                return;
            }
            
            try {
                // Capture frame from camera
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Send to backend for analysis
                const response = await fetch(`${API_BASE}/analyze_image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData,
                        student_id: studentId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Validate and sanitize the data before updating UI
                    const gazeScore = Math.max(0, Math.min(1, parseFloat(data.gaze_score || 0)));
                    const attentionScore = Math.max(0, Math.min(1, parseFloat(data.face_attention_score || 0)));
                    const cognitiveLoad = Math.max(0, Math.min(1, parseFloat(data.cognitive_load || 0)));
                    const engagementLevel = Math.max(0, Math.min(1, parseFloat(data.engagement_level || 0)));
                    
                    console.log('Analytics data received:', {
                        gaze_score: gazeScore,
                        face_attention_score: attentionScore,
                        cognitive_load: cognitiveLoad,
                        engagement_level: engagementLevel
                    });
                    
                    // Update metrics with validated data (convert to percentages)
                    // Show "--" for 0 values (no face detected)
                    document.getElementById('gazeMetric').textContent = gazeScore === 0 ? '--%' : Math.round(gazeScore * 100) + '%';
                    document.getElementById('attentionMetric').textContent = attentionScore === 0 ? '--%' : Math.round(attentionScore * 100) + '%';
                    document.getElementById('cognitiveMetric').textContent = cognitiveLoad === 0 ? '--%' : Math.round(cognitiveLoad * 100) + '%';
                    document.getElementById('engagementMetric').textContent = engagementLevel === 0 ? '--%' : Math.round(engagementLevel * 100) + '%';
                } else {
                    console.error('Analytics API error:', data.detail);
                    // Use default values on API error
                    setDefaultAnalyticsValues();
                }
            } catch (error) {
                console.error('Error analyzing frame:', error);
                // Use default values on network error
                setDefaultAnalyticsValues();
            }
        }

// Set default analytics values when camera/API fails
function setDefaultAnalyticsValues() {
    const defaultGaze = 75; // 75%
    const defaultAttention = 75; // 75%
    const defaultCognitive = 50; // 50%
    const defaultEngagement = 75; // 75%
    
    document.getElementById('gazeMetric').textContent = defaultGaze + '%';
    document.getElementById('attentionMetric').textContent = defaultAttention + '%';
    document.getElementById('cognitiveMetric').textContent = defaultCognitive + '%';
    document.getElementById('engagementMetric').textContent = defaultEngagement + '%';
    
    console.log('Using default analytics values');
}

// Enhanced auto tracking with frame analysis
function startAutoTracking() {
    // Start periodic frame analysis
    const trackingInterval = setInterval(() => {
        if (document.getElementById('cameraVideo').srcObject) {
            analyzeFrame();
        } else {
            clearInterval(trackingInterval);
        }
    }, 2000); // Analyze every 2 seconds
    
    // Store interval ID for cleanup
    window.trackingInterval = trackingInterval;
}
        
        function stopAutoTracking() {
            if (window.trackingInterval) {
                clearInterval(window.trackingInterval);
                window.trackingInterval = null;
            }
        }
        
        // Profile Functions
        function toggleProfileOverlay() {
            const overlay = document.getElementById('profileOverlay');
            overlay.classList.toggle('active');
            if (overlay.classList.contains('active')) {
                loadProfileData();
            }
        }
        
        function closeProfileOverlay(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('profileOverlay').classList.remove('active');
            }
        }
        
        function loadProfileData() {
            const studentId = localStorage.getItem('student_id');
            const userName = localStorage.getItem('user_name') || 'Student';
            const userEmail = localStorage.getItem('user_email') || 'student@example.com';
            
            // Update profile display
            document.getElementById('profileName').textContent = userName;
            document.getElementById('profileEmail').textContent = userEmail;
            document.getElementById('profileStudentId').textContent = `Student ID: ${studentId}`;
            document.getElementById('profileFullName').textContent = userName;
            document.getElementById('profileEmailDetail').textContent = userEmail;
            document.getElementById('profileStudentIdDetail').textContent = studentId;
        }
        
        async function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('passwordMessage');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showPasswordMessage('New passwords do not match!', 'error');
                return;
            }
            
            // Validate password strength
            if (newPassword.length < 6) {
                showPasswordMessage('Password must be at least 6 characters long!', 'error');
                return;
            }
            
            try {
                const studentId = localStorage.getItem('student_id');
                
                const response = await fetch(`${API_BASE}/students/${studentId}/change_password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showPasswordMessage('Password changed successfully!', 'success');
                    // Clear form
                    document.getElementById('changePasswordForm').reset();
                    // Close overlay after 2 seconds
                    setTimeout(() => {
                        closeProfileOverlay();
                    }, 2000);
                } else {
                    showPasswordMessage(data.detail || 'Error changing password. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showPasswordMessage('Network error. Please try again.', 'error');
            }
        }
        
        function showPasswordMessage(message, type) {
            const messageDiv = document.getElementById('passwordMessage');
            messageDiv.textContent = message;
            messageDiv.className = `password-message ${type}`;
            messageDiv.style.display = 'block';
            
            // Hide message after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
        
        // Password visibility toggle
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const eyeIcon = input.nextElementSibling.querySelector('.eye-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.textContent = '';
            } else {
                input.type = 'password';
                eyeIcon.textContent = '';
            }
        }
        
        // Password strength checker
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthDiv.style.display = 'none';
                return;
            }
            
            let strength = 0;
            let feedback = '';
            
            // Check length
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            
            // Check for different character types
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            // Determine strength level
            if (strength <= 2) {
                feedback = 'Weak password - add more characters and variety';
                strengthDiv.className = 'password-strength weak';
            } else if (strength <= 4) {
                feedback = 'Medium password - could be stronger';
                strengthDiv.className = 'password-strength';
            } else {
                feedback = 'Strong password!';
                strengthDiv.className = 'password-strength strong';
            }
            
            strengthDiv.textContent = feedback;
            strengthDiv.style.display = 'block';
        }
        
        // Password match checker
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (confirmPassword.length === 0) {
                matchDiv.style.display = 'none';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchDiv.textContent = ' Passwords match!';
                matchDiv.className = 'password-match';
            } else {
                matchDiv.textContent = ' Passwords do not match';
                matchDiv.className = 'password-match no-match';
            }
            
            matchDiv.style.display = 'block';
        }
        
        // Add event listeners for password checking
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function() {
                    checkPasswordStrength(this.value);
                    checkPasswordMatch();
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        });

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = 'auth.html';
        }
    </script>
</body>
</html>
